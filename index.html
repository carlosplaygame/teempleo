<!doctype html>
<html lang="es" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Executive JobBoard | Vacantes Disponibles</title>
  <meta name="description" content="Executive JobBoard | Vacantes disponibles. Filtra, busca y aplica a vacantes de Talento 3.0.">
  <link rel="icon" href="https://talento3.com/wp-content/uploads/2025/09/Logo-Talento-3.0-FAVICON.001.png" />
  <meta property="og:title" content="Executive JobBoard | Vacantes Disponibles">
  <meta property="og:description" content="Vacantes abiertas. Filtra por ciudad y palabras clave.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://talento3.com/wp-content/uploads/2024/04/LogoT3.png">
  <style>
    :root{
      --t3-primary:#0b3c5d; --t3-primary-600:#0e4a77;
      --t3-accent:#f39c12; --t3-bg:#f6f8fb; --t3-card:#ffffff;
      --t3-text:#1b1f23; --t3-muted:#6b7280; --radius:18px;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --st-new:#16a34a; --st-int:#f59e0b; --st-fin:#7c3aed;
      --c1:#2563eb; --c2:#f59e0b; --c3:#10b981; --c4:#8b5cf6; --c5:#ef4444; --c6:#14b8a6; --c7:#eab308; --c8:#6366f1; --c9:#f97316; --c10:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--t3-text);background:var(--t3-bg);line-height:1.5}
    a{color:var(--t3-primary-600);text-decoration:none}
    a:hover{text-decoration:underline}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    header{background:linear-gradient(135deg, var(--t3-primary) 0%, #102a43 100%);color:#fff;position:sticky;top:0;z-index:60;box-shadow:0 4px 18px rgba(0,0,0,.15)}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .nav{display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand a.logo{display:inline-flex;align-items:center}
    .brand img{height:48px;width:auto;border-radius:8px;background:#fff;padding:6px}
    .headtext{display:flex;flex-direction:column;gap:2px}
    .headtext h1{margin:0;font-size:18px;letter-spacing:.2px}
    .headtext .date{font-size:13px;opacity:.9}
    .stats{display:flex;align-items:center;gap:8px;color:#fff;font-size:14px;opacity:.95}
    .head-actions{display:flex;align-items:center;gap:12px}

    .toolbar{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){.toolbar{grid-template-columns:2.2fr 1.1fr 1.1fr auto auto}}
    .input, select{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:12px 14px;outline:none;box-shadow:inset 0 1px 0 rgba(0,0,0,.02);font-size:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:.15s transform ease,.15s box-shadow ease;box-shadow:var(--shadow);background:var(--t3-accent);color:#1b1f23}
    .btn.secondary{background:#fff;color:var(--t3-primary);border:1px solid #e5e7eb}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.35);box-shadow:none}
    .btn:hover{transform:translateY(-1px)}
    .btn.small{padding:8px 12px;font-size:13px;border-radius:10px}
    .searchWrap{display:grid;grid-template-columns:1fr 44px;align-items:stretch}
    .searchWrap .input{border-radius:12px 0 0 12px;border-right:0}
    .searchWrap .btn.tiny{border-radius:0 12px 12px 0;height:100%;padding:0;display:grid;place-items:center;min-width:44px}

    .legend{display:flex;gap:10px;align-items:center;margin-top:10px;font-size:12px;opacity:.95}
    .dot{display:inline-flex;align-items:center;gap:6px}
    .dot i{display:inline-block;width:10px;height:10px;border-radius:999px;background:#fff;opacity:.95}
    .dot.new i{background:var(--st-new)} .dot.int i{background:var(--st-int)} .dot.fin i{background:var(--st-fin)}

    .promo{background:linear-gradient(90deg,#fff 0%, #fff7ec 35%, #ffe4b8 100%); border-top:1px solid #f4cf94; border-bottom:1px solid #f4cf94}
    .promo .box{max-width:1280px;margin:0 auto;padding:8px 16px;display:flex;gap:12px;align-items:center}
    .ticker{overflow:hidden; white-space:nowrap; flex:1; mask-image:linear-gradient(90deg,transparent,black 8%,black 92%,transparent);}
    .track{display:inline-block; padding-left:100%; will-change:transform; animation:ticker 24s linear infinite;}
    @keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
    .promo .msg{display:inline-block; margin-right:28px; color:#5b3b00; font-weight:600}
    .promo .msg a{color:#7a4b00}

    main{padding:24px 0}
    .layout{display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:1100px){.layout{grid-template-columns:1fr 340px}}
    aside{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:14px;height:fit-content;position:sticky;top:90px}
    .aside-title{font-weight:800;margin:0 0 8px 0}
    .aside-section{margin-bottom:18px}
    .chart{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px}
    .chart h5{margin:0 0 8px 0;font-size:13px;color:#374151}
    canvas{width:100%;height:180px;display:block}
    @media(max-width:700px){ canvas{height:200px} }
    .legend-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:#374151;background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px}
    .legend-swatch{width:10px;height:10px;border-radius:2px}

    .quotes{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px}
    .quote{font-size:13px;color:#374151;margin:0 0 10px 0}
    .quote small{display:block;color:#6b7280;margin-top:4px}

    .list-head{display:flex;align-items:center;justify-content:space-between;margin:10px 0 16px 0;gap:8px;flex-wrap:wrap}
    .count{font-weight:700;color:var(--t3-primary-600)}
    .hint{font-size:12px;color:var(--t3-muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:700px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}

    .card{background:var(--t3-card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px}
    .badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:6px 10px;border-radius:999px;font-size:12px}
    .title{font-size:18px;font-weight:800;margin:0}
    .title a{color:inherit}
    .muted{color:var(--t3-muted);font-size:13px}
    .salary{display:flex;align-items:center;gap:8px;font-weight:700;color:var(--t3-primary)}
    .coin{width:18px;height:18px;display:inline-block}
    .desc{font-size:14px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
    .empty{text-align:center;background:#fff;border-radius:var(--radius);padding:28px;box-shadow:var(--shadow)}

    footer{padding:24px 0;color:var(--t3-muted);font-size:13px}

    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);transform:translateY(16px);opacity:0;pointer-events:none;transition:.25s ease;z-index:200}
    .toast.show{transform:translateY(0);opacity:1;pointer-events:auto}
    .topbtn{position:fixed;right:16px;bottom:16px;background:var(--t3-primary);color:#fff;border:0;border-radius:999px;width:46px;height:46px;display:grid;place-items:center;box-shadow:var(--shadow);cursor:pointer;display:none;z-index:200}

    .status-row{display:flex;align-items:center;gap:10px}
    .status-pill{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
    .progress{position:relative;width:100%;height:8px;border-radius:999px;background:#eef2f7;overflow:hidden}
    .progress .fill{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:999px;background:linear-gradient(90deg,var(--st-new),var(--st-int),var(--st-fin))}
    .owner{display:flex;align-items:center;gap:8px}
    .avatar{width:30px;height:30px;border-radius:999px;display:grid;place-items:center;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    .avatar svg{width:18px;height:18px;display:block}

    .modal-backdrop{position:fixed;inset:0;background:rgba(17,24,39,.6);display:none;z-index:300}
    .modal-backdrop.show{display:grid;place-items:center;animation:fadeIn .18s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{background:#fff;max-width:760px;width:92vw;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    .modal header{background:linear-gradient(135deg,var(--t3-primary) 0%, #102a43 100%);color:#fff;position:relative}
    .modal header .wrap{padding:14px 18px}
    .modal .close{position:absolute;top:10px;right:12px;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.4);border-radius:10px;padding:6px 10px;cursor:pointer}
    .modal .body{padding:16px 18px;max-height:70vh;overflow:auto}
    .modal .meta{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
    .modal .badge{background:#eef2ff;color:#3730a3}
    .modal .actions{margin-top:12px}
  </style>
</head>
<body>
  <a class="sr-only" href="#contenido">Saltar al contenido</a>

  <header>
    <div class="wrap">
      <div class="nav">
        <div class="brand">
          <a class="logo" href="https://talento3.com/" aria-label="Ir a Talento 3.0">
            <img src="https://talento3.com/wp-content/uploads/2024/04/LogoT3.png" alt="Logo Talento 3.0" />
          </a>
          <div class="headtext">
            <h1>Executive JobBoard | Vacantes Disponibles</h1>
            <div class="date" id="dateNow">Fecha: —</div>
          </div>
        </div>
        <div class="head-actions">
          <div class="stats"><span>Vacantes:</span><strong id="total">0</strong></div>
          <a href="https://talento3.com/" class="btn ghost small" aria-label="Regresar a Talento 3.0">Regresar a Talento 3.0</a>
        </div>
      </div>

      <div class="toolbar" aria-label="Filtros de búsqueda">
        <div class="searchWrap">
          <input id="q" class="input" type="search" placeholder="Buscar por palabras: puesto, descripción, lugar…" aria-label="Buscar palabras clave">
          <button id="doSearch" class="btn secondary tiny" title="Ejecutar búsqueda" aria-label="Ejecutar búsqueda">🔎</button>
        </div>
        <select id="city" aria-label="Filtrar por ciudad">
          <option value="">Todas las ciudades</option>
        </select>
        <select id="sort" aria-label="Ordenar resultados">
          <option value="dateDesc">Ordenar: Recientes</option>
          <option value="dateAsc">Ordenar: Antiguas</option>
          <option value="salaryDesc">Sueldo: mayor a menor</option>
          <option value="salaryAsc">Sueldo: menor a mayor</option>
          <option value="az">A–Z (puesto)</option>
          <option value="za">Z–A (puesto)</option>
        </select>
        <button id="refresh" class="btn" title="Recargar datos">Actualizar</button>
        <button id="toList" class="btn ghost" title="Ir a listado">Listado</button>
      </div>

      <div class="legend">
        <span class="dot new"><i></i> Nuevas</span>
        <span class="dot int"><i></i> Entrevistas</span>
        <span class="dot fin"><i></i> Finalistas</span>
      </div>
    </div>

    <div class="promo" aria-label="Información comercial Talento 3.0">
      <div class="box">
        <div class="ticker"><div id="promoTrack" class="track"></div></div>
      </div>
    </div>
  </header>

  <main class="wrap" id="contenido">
    <div class="layout">
      <!-- Columna principal -->
      <section style="min-width:0">
        <div class="list-head">
          <div class="count" id="countLabel">Mostrando 0 de 0 vacantes</div>
          <div class="hint">Consejo: filtra por ciudad y usa “Más info” para ver la descripción completa.</div>
        </div>

        <section id="cards" class="grid" aria-live="polite"></section>
        <div id="pager" class="pager" style="display:none">
          <button class="btn secondary" id="loadMore">Cargar más</button>
        </div>

        <div id="empty" class="empty" style="display:none">
          <h3>No pude cargar <code>positions.csv</code></h3>
          <p>Coloca el archivo <strong>positions.csv</strong> en la misma carpeta que este HTML y abre el sitio desde un <em>servidor local</em> (ej. Live Server). También puedes cargarlo manualmente:</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
            <button class="btn" id="retry">Reintentar</button>
            <button class="btn secondary" id="pickCsv">Cargar positions.csv</button>
            <input type="file" id="fileInput" accept=".csv,text/csv" style="display:none">
          </div>
        </div>

        <div id="schemaDump" style="display:none"></div>
      </section>

      <!-- Sidebar derecha -->
      <aside>
        <div class="aside-section chart">
          <h5>Especialidades más buscadas</h5>
          <canvas id="chartCats"></canvas>
        </div>
        <div class="aside-section chart">
          <h5>Vacantes por región (Top 8)</h5>
          <canvas id="chartCities"></canvas>
        </div>
        <div class="aside-section chart">
          <h5>Habilidades requeridas</h5>
          <canvas id="chartSkills"></canvas>
          <div id="legendSkills" class="legend-list" aria-hidden="true"></div>
        </div>
        <div class="aside-section quotes">
          <h5 class="aside-title" style="margin-bottom:8px">Lo que dicen</h5>
          <p class="quote">“Proceso claro y ágil; recibimos postulaciones relevantes.”<small>Gerente de Operaciones</small></p>
          <p class="quote">“Excelente visibilidad y candidatos calificados.”<small>Directora de RH</small></p>
          <p class="quote">“La asistencia con IA elevó la tasa de respuesta.”<small>Líder de Selección</small></p>
        </div>
      </aside>
    </div>
  </main>

  <footer>
    <div class="wrap">
      © <span id="year"></span> Talento 3.0. Portal administrado por <strong>administrador</strong>. · Optimizado para SEO y Google Jobs.
    </div>
  </footer>

  <button id="topBtn" class="topbtn" aria-label="Volver arriba" title="Volver arriba">↑</button>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <div class="wrap">
          <button class="close" id="modalClose" aria-label="Cerrar">✕</button>
          <h2 id="modalTitle" style="margin:0;font-size:18px">Vacante</h2>
        </div>
      </header>
      <div class="body">
        <div class="meta" id="modalMeta"></div>
        <div class="status-row" style="margin-bottom:8px">
          <span class="status-pill" id="modalStatus"></span>
          <div class="progress" aria-hidden="true" style="flex:1;max-width:360px"><div class="fill" id="modalProg"></div></div>
        </div>
        <div class="desc" id="modalShort"></div>
        <div id="modalFull" style="white-space:pre-wrap; margin-top:8px; display:none" class="desc"></div>
        <button class="btn secondary" id="modalToggle" style="margin-top:8px">Ver más</button>

        <!-- Form embebido -->
        <div class="formWrap" id="formWrap" style="display:none; margin-top:12px">
          <iframe id="formFrame" src="" title="Formulario de aplicación"
                  style="width:100%;height:720px;border:0;border-radius:12px;box-shadow:var(--shadow)"
                  allow="fullscreen; geolocation *; microphone *; camera *" referrerpolicy="no-referrer"></iframe>
          <div class="formFallback" id="formFallback" style="display:none;margin-top:8px">
            <strong>No pudimos incrustar el formulario aquí.</strong> Ábrelo en esta página:
            <a id="formLink" href="#" target="_blank" rel="noopener">Abrir formulario</a>
          </div>
        </div>

        <div class="actions">
          <button id="modalApply" class="btn">Aplicar</button>
          <a id="modalShareWA" class="btn secondary" href="#" target="_blank" rel="noopener" title="WhatsApp (compartir con un amigo o conocido)">WhatsApp (compartir con un amigo)</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Agente IA (Jotform) opcional -->
  <script src="https://cdn.jotfor.ms/agent/embedjs/0199263e5f5a7199a83430be0e855bd38fa8/embed.js"></script>

  <script>
  (()=>{
    const CSV_URL='positions.csv';
    const PROMO_MESSAGES=["Información y Ventas (800) 00 106 89","Escríbenos: info@talento3.com","Visita: www.talento3.com"];

    const SKILL_RULES=[
      {key:'Inglés', rx:/\bingl[eé]s\b/i},
      {key:'Excel/Office', rx:/\b(excel|office|hojas de c[aá]lculo)\b/i},
      {key:'Liderazgo', rx:/\bliderazg|lider\b/i},
      {key:'Project Mgmt', rx:/\b(project|scrum|kanban|pm)\b/i},
      {key:'SAP/ERP', rx:/\b(sap|erp|oracle)\b/i},
      {key:'Análisis de datos', rx:/\b(datos|analytics?|power ?bi|tableau|sql|python)\b/i},
      {key:'Ventas/Negociación', rx:/\bventas?|negociaci[oó]n\b/i},
      {key:'Calidad/Seguridad', rx:/\b(calidad|seguridad|hse|sso|iso)\b/i},
    ];
    const CAT_RULES=[
      {key:'Ventas', rx:/\b(ventas?|comercial|account|ejecutiv[oa]|kpi|crm)\b/i},
      {key:'Finanzas', rx:/\b(finanzas?|contab|tesorer|cobranz|fiscal|auditor)\b/i},
      {key:'RH', rx:/\b(recursos humanos|rh|talento|recluta|nomina|capacita)\b/i},
      {key:'Tecnología', rx:/\b(software|desarroll|tech|ti|it|sistemas|data|devops|soporte)\b/i},
      {key:'Operaciones', rx:/\b(operacion|produccion|planta|mantenimiento|calidad|lean)\b/i},
      {key:'Logística', rx:/\b(logistic|almacen|suministro|cadena|transporte|rutas)\b/i},
      {key:'Marketing', rx:/\b(marketing|mercadotecnia|brand|contenido|seo|social|growth)\b/i},
      {key:'Legal', rx:/\b(legal|juridic|compliance|contratos?)\b/i},
    ];
    const PALETTE=['#2563eb','#f59e0b','#10b981','#8b5cf6','#ef4444','#14b8a6','#eab308','#6366f1','#f97316','#22c55e','#0ea5e9','#d946ef'];

    const $=s=>document.querySelector(s);
    const $$=s=>Array.from(document.querySelectorAll(s));
    const toast=(m,ok=false)=>{const t=$('#toast');t.textContent=m;t.style.background=ok?'linear-gradient(135deg,#15803d,#16a34a)':'#111827';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400)}
    const sanitize=s=>String(s??'').trim();
    const escapeHtml=s=>String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const slugify=s=>s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const PALETTE_AV=['#0ea5e9','#f97316','#22c55e','#8b5cf6','#ef4444','#10b981','#8b5cf6','#f59e0b','#14b8a6','#e11d48'];
    const ownerColor=(seed='')=>{const str=seed||'owner';const hash=[...str].reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0),0);return PALETTE_AV[Math.abs(hash)%PALETTE_AV.length];}
    const statusFromId=(id)=>{const hash=[...id].reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0),0);const idx=Math.abs(hash)%3;const labels=['Nueva','Entrevistas','Finalistas'];return {idx,label:labels[idx],progress:Math.round(((idx+1)/3)*100)};}

    const formatWithCommas=n=>String(n||'').replace(/\B(?=(\d{3})+(?!\d))/g,',');
    const parseWholeAmount=raw=>{if(raw==null)return null;const s=String(raw).replace(/\s+/g,'');const m=s.match(/(\d{1,3}(?:[.,]\d{3})+|\d+)(?:[.,](\d{1,2}))?/);if(!m)return null;const whole=m[1].replace(/[^\d]/g,'');return whole&&/^\d+$/.test(whole)?whole:null};
    const salaryPrettyFromCSV=r=>{const w=parseWholeAmount(r);return w?('$'+formatWithCommas(w)+' MXN'):'No especificado';};
    const extractNumber=r=>{const w=parseWholeAmount(r);return w?parseInt(w,10):undefined;};
    const shortByPercent=(s,p=0.25,max=1000)=>{if(!s)return'';const L=s.length;let n=Math.max(1,Math.floor(L*p));n=Math.min(n,max);return n>=L?s:s.slice(0,n)+'…';};
    const parseDate=s=>{const d=new Date(s||'');return isNaN(d)?null:d;};
    const coinSVG=()=>`<svg class="coin" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="#ffd166"/><circle cx="12" cy="12" r="8" fill="#fbbf24"/><path d="M9 9.5h5.5M9 14.5h5.5M12 7v10" stroke="#8a5a00" stroke-width="1.5" stroke-linecap="round"/></svg>`;
    const waMessage=j=>`Creo que este empleo te puede interesar: ${j.puesto} 💼\nAplica aquí: ${j.link} ✨📲`;
    const waHref=j=> j?.link ? `https://api.whatsapp.com/send?text=${encodeURIComponent(waMessage(j))}` : null;

    function setHeaderDate(){ const now=new Date(); const long=now.toLocaleDateString('es-MX',{day:'numeric',month:'long',year:'numeric'}); $('#dateNow').textContent='Fecha: '+long.charAt(0).toUpperCase()+long.slice(1); $('#year').textContent=now.getFullYear(); }
    function buildPromo(){ const track=$('#promoTrack'); track.innerHTML=''; const span=document.createElement('span'); span.className='msg'; span.textContent=PROMO_MESSAGES.join('   •   '); track.appendChild(span); }

    function parseCSV(text){
      text=String(text||'').replace(/^\uFEFF/,'').replace(/\r\n?/g,'\n'); if(!text.trim()) return [];
      const firstLine=text.split('\n').find(l=>l.trim().length)||''; const cands=[',',';','\t','|']; const count=(l,d)=>(l.match(new RegExp('\\'+d,'g'))||[]).length;
      let best=cands[0],bestN=-1; for(const d of cands){const n=count(firstLine,d); if(n>bestN){best=d;bestN=n;}}
      function parseWith(del){const rows=[];let i=0,field='',row=[],inQ=false;const pushF=()=>{row.push(field);field=''};const pushR=()=>{rows.push(row);row=[]};
        while(i<text.length){const ch=text[i];
          if(inQ){if(ch=='"'){if(text[i+1]=='"'){field+='"';i+=2;continue;}inQ=false;i++;continue;}field+=ch;i++;continue;}
          if(ch=='"'){inQ=true;i++;continue;}
          if(ch==del){pushF();i++;continue;}
          if(ch=='\n'){pushF();pushR();i++;continue;}
          field+=ch;i++;}
        if(field!==''||row.length){pushF();pushR();} return rows;}
      let table=parseWith(best); if(table[0]&&table[0].length<2){for(const d of cands){if(d===best)continue;const t=parseWith(d);if(t[0]&&t[0].length>1){table=t;break;}}}
      if(!table.length) return []; const headers=table[0].map(h=>String(h??'').trim());
      const data=table.slice(1).filter(r=>r.some(x=>String(x??'').trim()!=='')); return data.map(r=>{const o={};headers.forEach((h,i)=>o[h]=r[i]!==undefined?r[i]:'');return o;});
    }

    function normalizeRows(rows){
      const norm=s=>String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[:]/g,'').replace(/\s+/g,' ').trim();
      const idx={}; Object.keys(rows[0]).forEach(h=>{idx[norm(h)]=h});
      const H=raw=>idx[norm(raw)]??raw;
      return rows.map((r,i)=>{
        const puesto=sanitize(r[H('Puesto')]);
        const ciudad=sanitize(r[H('Ciudad')]);
        const lugar=sanitize(r[H('Lugar centro de trabajo')]);
        const sueldo=sanitize(r[H('Sueldo Mensual')]);
        const creacion=sanitize(r[H('Creacion')]);
        const infoFull=sanitize(r[H('Información de la Vacante:')]||r[H('Información de la Vacante')]);
        const link=sanitize(r[H('Link para aplicar a vacante')]);
        const titular=sanitize(r[H('Titular')]);
        const id=`${slugify(puesto||'vacante')}-${i+1}`;
        const status=statusFromId(id);
        const infoShort=shortByPercent(infoFull,0.25,1000);
        const color=ownerColor(titular);
        const createdAt=parseDate(creacion);
        const salaryNum=extractNumber(sueldo)||0;
        return {id,puesto,ciudad,lugar,sueldo,creacion,createdAt,salaryNum,infoFull,infoShort,link,titular,status,color};
      });
    }

    const state={jobs:[],filtered:[],page:1,pageSize:12,current:null,lastFocus:null};

    function populateCities(){
      const cities=[...new Set(state.jobs.map(j=>j.ciudad).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
      $('#city').innerHTML = `<option value="">Todas las ciudades</option>` + cities.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    }
    function updateStats(show,total){ $('#total').textContent=total; $('#countLabel').textContent=`Mostrando ${show} de ${total} vacantes`; }

    function sortItems(arr){
      const mode=$('#sort').value||'dateDesc';
      const byTitle=(a,b)=>(a.puesto||'').localeCompare(b.puesto||'','es');
      const byDate=(a,b)=>((b.createdAt?.getTime()||0)-(a.createdAt?.getTime()||0));
      const byDateAsc=(a,b)=>((a.createdAt?.getTime()||0)-(b.createdAt?.getTime()||0));
      const bySal=(a,b)=>(b.salaryNum-a.salaryNum);
      const bySalAsc=(a,b)=>(a.salaryNum-b.salaryNum);
      const copy=[...arr];
      switch(mode){
        case 'dateAsc': copy.sort(byDateAsc); break;
        case 'salaryDesc': copy.sort(bySal); break;
        case 'salaryAsc': copy.sort(bySalAsc); break;
        case 'az': copy.sort(byTitle); break;
        case 'za': copy.sort((a,b)=>byTitle(b,a)); break;
        default: copy.sort(byDate);
      }
      return copy;
    }
    function getPaged(items){ const end=state.page*state.pageSize; const slice=items.slice(0,end); $('#pager').style.display = end<items.length?'flex':'none'; return slice; }

    function renderList(items){
      const wrap=$('#cards'); wrap.innerHTML='';
      if(!items.length){ $('#empty').style.display = state.jobs.length ? 'none':'block'; updateStats(0,state.jobs.length); return; }
      $('#empty').style.display='none';

      const sorted=sortItems(items);
      const paged=getPaged(sorted);
      const frag=document.createDocumentFragment();

      paged.forEach(j=>{
        const wa=waHref(j);
        const shareBtn = wa ? `<a class="btn secondary" href="${wa}" target="_blank" rel="noopener" title="WhatsApp (compartir con un amigo o conocido)">WhatsApp (compartir con un amigo)</a>` : `<button class="btn secondary" disabled>WhatsApp (compartir)</button>`;
        const applyBtn = j.link ? `<button class="btn" data-open-apply="${j.id}">Aplicar</button>` : `<button class="btn" disabled>Aplicar</button>`;
        const statusPct=j.status.progress, statusLbl=j.status.label;

        const card=document.createElement('article'); card.className='card';
        card.innerHTML=`
          <div class="badge">${escapeHtml(j.ciudad || 'Ubicación no especificada')}</div>
          <h3 class="title"><a href="#/job/${encodeURIComponent(j.id)}" data-open-info="${j.id}">${escapeHtml(j.puesto || 'Puesto no especificado')}</a></h3>
          <div class="muted">${escapeHtml(j.lugar || 'Centro de trabajo no especificado')}</div>

          <div class="owner" title="Ejecutivo/a asignado">
            <div class="avatar" style="background:${j.color}">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10" fill="rgba(255,255,255,.2)"/>
                <circle cx="9" cy="10" r="1.2" fill="#fff"/><circle cx="15" cy="10" r="1.2" fill="#fff"/>
                <path d="M7.5 14a4.5 4.5 0 0 0 9 0" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round"/>
              </svg>
            </div>
          </div>

          <div class="status-row">
            <span class="status-pill">Estado: ${escapeHtml(statusLbl)}</span>
            <div class="progress" aria-hidden="true"><div class="fill" style="width:${statusPct}%"></div></div>
          </div>

          <div class="salary">${coinSVG()} <span>Sueldo mensual: ${salaryPrettyFromCSV(j.sueldo)}</span></div>

          <p class="desc">${escapeHtml(j.infoShort || '')}</p>

          <div class="actions">
            ${applyBtn}
            <button class="btn secondary" data-open-info="${j.id}">Más info</button>
            ${shareBtn}
          </div>
        `;
        frag.appendChild(card);
      });
      wrap.appendChild(frag);

      wrap.querySelectorAll('[data-open-info]').forEach(el=>el.addEventListener('click', (e)=>{
        e.preventDefault(); state.lastFocus=e.currentTarget;
        const id=e.currentTarget.getAttribute('data-open-info'); const job=state.jobs.find(x=>x.id===id);
        if(job){ openModal(job,'info'); location.hash='#/job/'+encodeURIComponent(id); }
      }));
      wrap.querySelectorAll('[data-open-apply]').forEach(el=>el.addEventListener('click', (e)=>{
        e.preventDefault(); state.lastFocus=e.currentTarget;
        const id=e.currentTarget.getAttribute('data-open-apply'); const job=state.jobs.find(x=>x.id===id);
        if(job){ openModal(job,'apply'); location.hash='#/job/'+encodeURIComponent(id); }
      }));

      updateStats(paged.length, state.jobs.length);
      injectSchemas(paged);
      updateCharts(items);
    }

    /* Modal + Form embebido con fallback */
    function showModal(){ const m=$('#modal'); m.classList.add('show'); m.removeAttribute('aria-hidden'); document.body.style.overflow='hidden'; }
    function closeModal(){ const m=$('#modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; hideForm(); if(state.lastFocus){state.lastFocus.focus();} }
    function showForm(job){
      const wrap=$('#formWrap'), frame=$('#formFrame'), fb=$('#formFallback'), link=$('#formLink');
      if(!job.link){ wrap.style.display='none'; fb.style.display='none'; toast('No hay enlace para aplicar.'); return; }
      wrap.style.display='block'; fb.style.display='none'; link.href=job.link;

      // Reset + intentar cargar
      frame.src='about:blank';
      // Si el origen bloquea X-Frame-Options, el onload puede no disparar: ponemos timeout de diagnóstico
      let fired=false;
      const onLoad=()=>{fired=true; /* si carga, todo ok */};
      frame.addEventListener('load', onLoad, {once:true});
      frame.src=job.link;

      // Diagnóstico en 1500ms: si no cargó, mostrar fallback
      setTimeout(()=>{
        if(!fired){
          fb.style.display='block';
          // Opcional: abrir en la misma pestaña
          // window.open(job.link, '_blank', 'noopener');
        }
      },1500);

      setTimeout(()=>{ frame.scrollIntoView({behavior:'smooth',block:'start'}); },100);
    }
    function hideForm(){ const wrap=$('#formWrap'), frame=$('#formFrame'); wrap.style.display='none'; frame.src='about:blank'; }

    function openModal(job,mode='info'){
      state.current=job;
      $('#modalTitle').textContent=job.puesto||'Vacante';
      $('#modalMeta').innerHTML=`<span class="badge">${escapeHtml(job.ciudad||'Ubicación')}</span> <span class="badge">💰 ${salaryPrettyFromCSV(job.sueldo)}</span>`;
      $('#modalStatus').textContent='Estado: '+job.status.label;
      $('#modalProg').style.width=job.status.progress+'%';
      $('#modalShort').textContent=job.infoShort||'';
      $('#modalFull').textContent=job.infoFull||''; $('#modalFull').style.display='none'; $('#modalToggle').textContent='Ver más';

      const wa=waHref(job); const waBtn=$('#modalShareWA'); if(wa){ waBtn.href=wa; waBtn.removeAttribute('aria-disabled'); } else { waBtn.href='#'; waBtn.setAttribute('aria-disabled','true'); }
      $('#modalApply').onclick=()=>showForm(job);

      showModal(); if(mode==='apply') showForm(job);
    }
    $('#modalToggle').addEventListener('click',()=>{const full=$('#modalFull');const open=full.style.display!=='none';if(open){full.style.display='none';$('#modalToggle').textContent='Ver más';}else{full.style.display='block';$('#modalToggle').textContent='Ver menos';}})
    $('#modalClose').addEventListener('click',()=>{closeModal();history.replaceState(null,'',location.pathname+location.search);})
    $('#modal').addEventListener('click',(e)=>{if(e.target.id==='modal'){closeModal();history.replaceState(null,'',location.pathname+location.search);}})
    window.addEventListener('keydown',(e)=>{if(e.key==='Escape'){closeModal();history.replaceState(null,'',location.pathname+location.search);}})

    /* Schema.org JobPosting */
    const isoDate=s=>{const d=new Date(s||Date.now());return isNaN(d.getTime())?new Date().toISOString():d.toISOString();}
    function validThrough(creacion){const d=new Date(creacion||Date.now());return new Date((isNaN(d)?Date.now():d.getTime())+60*24*3600*1000).toISOString();}
    function injectSchemas(items){
      const dump=$('#schemaDump'); dump.innerHTML='';
      items.forEach(j=>{
        const payload={"@context":"https://schema.org/","@type":"JobPosting","title":j.puesto||"Vacante",
          "description":(j.infoFull||'').replace(/\n/g,'<br>'),"datePosted":isoDate(j.creacion),"employmentType":"FULL_TIME",
          "hiringOrganization":{"@type":"Organization","name":"Talento 3.0","sameAs":"https://talento3.com","logo":"https://talento3.com/wp-content/uploads/2024/04/LogoT3.png"},
          "jobLocation":{"@type":"Place","address":{"@type":"PostalAddress","addressLocality":j.ciudad||"México","streetAddress":j.lugar||""}},
          "directApply":true,"validThrough":validThrough(j.creacion),
          "baseSalary": j.sueldo?{"@type":"MonetaryAmount","currency":"MXN","value":{"@type":"QuantitativeValue","value":extractNumber(j.sueldo),"unitText":"MONTH"}}:undefined,
          "applicantLocationRequirements":{"@type":"Country","name":"MX"}};
        const s=document.createElement('script'); s.type='application/ld+json'; s.textContent=JSON.stringify(payload); dump.appendChild(s);
      });
    }

    /* ====== GRÁFICAS SIN SUPERPOSICIÓN ====== */
    function colorAt(i){ return PALETTE[i % PALETTE.length]; }

    // Barras VERTICALES (Categorías) — sin números
    function drawBarsVertical(canvas, labels, values){
      if(!canvas) return; const ctx=canvas.getContext('2d');
      const W=canvas.clientWidth, H=canvas.clientHeight; canvas.width=W; canvas.height=H;
      ctx.clearRect(0,0,W,H); if(!values.length) return;
      const pairs=labels.map((l,i)=>({l:String(l), v:values[i], c:colorAt(i)})).sort((a,b)=>b.v-a.v).slice(0,8);
      const maxV=Math.max(...pairs.map(p=>p.v))||1, n=pairs.length, pad=14;
      const step=(W-pad*2)/n, barW=step*0.66;
      ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      pairs.forEach((p,i)=>{ const x=pad+i*step+(step-barW)/2; const h=(H-40)*(p.v/maxV); const y=H-24-h;
        ctx.fillStyle=p.c; ctx.fillRect(x,y,barW,h);
        // Etiqueta (sin número), truncada
        ctx.fillStyle='#374151'; const lab=p.l.length>12?p.l.slice(0,12)+'…':p.l; ctx.fillText(lab, x, H-8);
      });
    }

    // Barras HORIZONTALES (Ciudades) — sin números, etiqueta a la izquierda
    function drawBarsHorizontal(canvas, labels, values){
      if(!canvas) return; const ctx=canvas.getContext('2d');
      const W=canvas.clientWidth, H=canvas.clientHeight; canvas.width=W; canvas.height=H;
      ctx.clearRect(0,0,W,H); if(!values.length) return;
      const pairs=labels.map((l,i)=>({l:String(l), v:values[i], c:colorAt(i)})).sort((a,b)=>b.v-a.v).slice(0,8);
      const maxV=Math.max(...pairs.map(p=>p.v))||1, n=pairs.length;
      const top=10, bottom=10, left=90, right=10;
      const band=(H-top-bottom)/n*0.9, gap=((H-top-bottom)/n)-band;
      ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Arial'; ctx.textBaseline='middle';
      pairs.forEach((p,i)=>{ const y=top+i*(band+gap)+band/2; const len=(W-left-right)*(p.v/maxV);
        // etiqueta izquierda
        ctx.fillStyle='#374151'; let lab=p.l.length>18?p.l.slice(0,18)+'…':p.l; ctx.fillText(lab, 6, y);
        // barra
        ctx.fillStyle=p.c; ctx.fillRect(left, y-band/2, Math.max(2,len), band);
      });
    }

    // DONA (Skills) — sin números; leyenda aparte
    function drawDonut(canvas, labels, values, legendEl){
      if(!canvas) return; const ctx=canvas.getContext('2d');
      const W=canvas.clientWidth, H=canvas.clientHeight; canvas.width=W; canvas.height=H;
      ctx.clearRect(0,0,W,H);
      const total=values.reduce((a,b)=>a+b,0);
      if(!total){ if(legendEl) legendEl.innerHTML=''; return; }
      const cx=W/2, cy=H/2, r=Math.min(W,H)/2-10, r2=r*0.58;
      let ang= -Math.PI/2;
      labels.forEach((lab,i)=>{
        const val=values[i]; if(!val) return;
        const frac=val/total; const a2=ang+2*Math.PI*frac;
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,ang,a2); ctx.closePath();
        ctx.fillStyle=colorAt(i); ctx.fill();
        ang=a2;
      });
      // agujero
      ctx.globalCompositeOperation='destination-out';
      ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation='source-over';
      // leyenda
      if(legendEl){
        legendEl.innerHTML='';
        labels.forEach((lab,i)=>{
          const val=values[i]; if(!val) return;
          const item=document.createElement('span'); item.className='legend-item';
          const sw=document.createElement('span'); sw.className='legend-swatch'; sw.style.background=colorAt(i);
          const tx=document.createElement('span'); tx.textContent=lab;
          item.appendChild(sw); item.appendChild(tx); legendEl.appendChild(item);
        });
      }
    }

    function updateCharts(items){
      // Categorías desde títulos
      const byCat={}; items.forEach(j=>{ const c=inferCategory(j.puesto); byCat[c]=(byCat[c]||0)+1; });
      const catLabels=Object.keys(byCat), catVals=Object.values(byCat);
      drawBarsVertical($('#chartCats'), catLabels, catVals);

      // Ciudades (Top 8) — barras horizontales
      const byCity={}; items.forEach(j=>{ const c=j.ciudad||'—'; byCity[c]=(byCity[c]||0)+1; });
      const cityLabels=Object.keys(byCity), cityVals=Object.values(byCity);
      drawBarsHorizontal($('#chartCities'), cityLabels, cityVals);

      // Habilidades — dona + leyenda
      const skillCount={}; items.forEach(j=>{ const s=countSkills(j.infoFull); Object.entries(s).forEach(([k,v])=>{skillCount[k]=(skillCount[k]||0)+v;}); });
      const skillLabels=Object.keys(skillCount), skillVals=Object.values(skillCount);
      drawDonut($('#chartSkills'), skillLabels, skillVals, $('#legendSkills'));
    }

    function inferCategory(title){ for(const r of CAT_RULES){ if(r.rx.test(title||'')) return r.key; } return 'Otros'; }
    function countSkills(text){
      const counts={}; const s=String(text||'');
      SKILL_RULES.forEach(r=>{ const matches=s.match(r.rx); counts[r.key]=(counts[r.key]||0)+(matches? (s.match(new RegExp(r.rx,'gi'))||[]).length : 0); });
      return counts;
    }

    function applyFilters(){
      const q=$('#q').value.trim().toLowerCase();
      const city=$('#city').value.trim().toLowerCase();
      state.page=1;
      state.filtered = state.jobs.filter(j=>{
        const okCity=!city || (j.ciudad||'').toLowerCase()===city;
        const txt=[j.puesto,j.infoFull,j.lugar,j.ciudad,j.sueldo,j.titular].join(' ').toLowerCase();
        const okQ=!q || txt.includes(q);
        return okCity && okQ;
      });
      renderList(state.filtered);
    }

    async function loadCSV(){
      try{
        const res = await fetch(CSV_URL + '?t=' + Date.now(), {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const head = text.slice(0,180).toLowerCase();
        if(head.includes('<!doctype') || head.includes('<html')) throw new Error('Respuesta HTML (posible bloqueo por file://).');
        const rows = parseCSV(text);
        if(!rows.length) throw new Error('CSV vacío o sin filas útiles.');
        state.jobs = normalizeRows(rows);
        state.filtered = [...state.jobs];
        state.page = 1;
        populateCities(); renderList(state.filtered);
        $('#empty').style.display='none'; toast('Vacantes cargadas', true);
        handleHashRoute();
      }catch(e){
        console.warn('Error CSV:', e);
        showEmpty();
      }
    }

    function showEmpty(){
      $('#cards').innerHTML=''; $('#empty').style.display='block';
      updateStats(0,0); injectSchemas([]);
    }

    function handleHashRoute(){ const h=location.hash||''; const m=h.match(/^#\/job\/(.+)$/); if(m){ const id=decodeURIComponent(m[1]); const job=state.jobs.find(j=>j.id===id); if(job) openModal(job,'info'); } }
    window.addEventListener('hashchange', handleHashRoute);

    $('#q').addEventListener('keydown',(e)=>{ if(e.key==='Enter') applyFilters(); });
    $('#doSearch').addEventListener('click', applyFilters);
    $('#city').addEventListener('change', applyFilters);
    $('#sort').addEventListener('change', ()=>renderList(state.filtered));
    $('#refresh').addEventListener('click', loadCSV);
    $('#retry').addEventListener('click', loadCSV);
    $('#toList').addEventListener('click',(e)=>{e.preventDefault();window.scrollTo({top:0,behavior:'smooth'});});
    $('#loadMore').addEventListener('click', ()=>{ state.page++; renderList(state.filtered); });

    $('#pickCsv')?.addEventListener('click', ()=> $('#fileInput').click());
    $('#fileInput')?.addEventListener('change', async e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const text=await f.text();
      const rows=parseCSV(text);
      if(!rows.length){ toast('CSV vacío o inválido'); return; }
      state.jobs = normalizeRows(rows);
      state.filtered=[...state.jobs]; state.page=1;
      populateCities(); renderList(state.filtered);
      $('#empty').style.display='none';
      toast('Vacantes cargadas (archivo local)', true);
    });

    const topBtn=$('#topBtn');
    window.addEventListener('scroll', ()=>{ topBtn.style.display = window.scrollY>500 ? 'grid':'none'; });
    topBtn.addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));

    // SEO schemas
    const isoDate=s=>{const d=new Date(s||Date.now());return isNaN(d.getTime())?new Date().toISOString():d.toISOString();};
    function validThrough(creacion){const d=new Date(creacion||Date.now());return new Date((isNaN(d)?Date.now():d.getTime())+60*24*3600*1000).toISOString();}
    function injectSchemas(items){
      const dump=$('#schemaDump'); dump.innerHTML='';
      items.forEach(j=>{
        const payload={"@context":"https://schema.org/","@type":"JobPosting","title": j.puesto || "Vacante",
          "description": (j.infoFull||'').replace(/\n/g,'<br>'),"datePosted": isoDate(j.creacion),"employmentType":"FULL_TIME",
          "hiringOrganization":{"@type":"Organization","name":"Talento 3.0","sameAs":"https://talento3.com","logo":"https://talento3.com/wp-content/uploads/2024/04/LogoT3.png"},
          "jobLocation":{"@type":"Place","address":{"@type":"PostalAddress","addressLocality": j.ciudad || "México","streetAddress": j.lugar || ""}},
          "directApply": true,"validThrough": validThrough(j.creacion),
          "baseSalary": j.sueldo ? {"@type":"MonetaryAmount","currency":"MXN","value":{"@type":"QuantitativeValue","value": extractNumber(j.sueldo),"unitText":"MONTH"}} : undefined,
          "applicantLocationRequirements":{"@type":"Country","name":"MX"}};
        const s=document.createElement('script'); s.type='application/ld+json'; s.textContent=JSON.stringify(payload); dump.appendChild(s);
      });
    }

    // Init
    (function initHead(){ const now=new Date(); const fmt=now.toLocaleDateString('es-MX',{day:'numeric',month:'long',year:'numeric'}); $('#dateNow').textContent='Fecha: '+fmt.charAt(0).toUpperCase()+fmt.slice(1); $('#year').textContent=now.getFullYear(); const track=$('#promoTrack'); track.innerHTML=''; const span=document.createElement('span'); span.className='msg'; span.textContent=PROMO_MESSAGES.join('   •   '); track.appendChild(span); })();
    loadCSV();
  })();
  </script>
</body>
</html>
