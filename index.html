<!-- Talento 3.0 JobBoard ‚Äî HTML listo para pegar en una p√°gina de WordPress (bloque HTML) -->
<div id="t3jb" data-csv="https://talento3.com/?t3_csv=empleos" data-cache="false">
  <style>
    /* ======= Estilos encapsulados ======= */
    #t3jb { font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:#1b1f23; }
    #t3jb a { color:#0e4a77; text-decoration:none }
    #t3jb a:hover { text-decoration:underline }
    #t3jb .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Header */
    #t3jb .t3-header{background:linear-gradient(135deg,#0b3c5d 0%, #102a43 100%);color:#fff;position:sticky;top:0;z-index:60;box-shadow:0 4px 18px rgba(0,0,0,.15)}
    #t3jb .wrap{max-width:1280px;margin:0 auto;padding:16px}
    #t3jb .nav{display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap}
    #t3jb .brand{display:flex;align-items:center;gap:12px}
    #t3jb .brand a.logo{display:inline-flex;align-items:center}
    #t3jb .brand img{height:48px;width:auto;border-radius:8px;background:#fff;padding:6px}
    #t3jb .headtext{display:flex;flex-direction:column;gap:2px}
    #t3jb .headtext h1{margin:0;font-size:18px;letter-spacing:.2px}
    #t3jb .headtext .date{font-size:13px;opacity:.9}
    #t3jb .stats{display:flex;align-items:center;gap:8px;color:#fff;font-size:14px;opacity:.95}
    #t3jb .head-actions{display:flex;align-items:center;gap:12px}

    /* Toolbar */
    #t3jb .toolbar{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){#t3jb .toolbar{grid-template-columns:2.2fr 1.1fr 1.1fr auto auto}}
    #t3jb .input, #t3jb select{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:12px 14px;outline:none;box-shadow:inset 0 1px 0 rgba(0,0,0,.02);font-size:14px}
    #t3jb .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:.15s transform ease,.15s box-shadow ease;box-shadow:0 8px 24px rgba(0,0,0,.08);background:#f39c12;color:#1b1f23}
    #t3jb .btn.secondary{background:#fff;color:#0b3c5d;border:1px solid #e5e7eb}
    #t3jb .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.35);box-shadow:none}
    #t3jb .btn:hover{transform:translateY(-1px)}
    #t3jb .btn.small{padding:8px 12px;font-size:13px;border-radius:10px}
    #t3jb .searchWrap{display:grid;grid-template-columns:1fr 44px;align-items:stretch}
    #t3jb .searchWrap .input{border-radius:12px 0 0 12px;border-right:0}
    #t3jb .searchWrap .btn.tiny{border-radius:0 12px 12px 0;height:100%;padding:0;display:grid;place-items:center;min-width:44px}

    /* Banner */
    #t3jb .promo{background:linear-gradient(90deg,#fff 0%, #fff7ec 35%, #ffe4b8 100%); border-top:1px solid #f4cf94; border-bottom:1px solid #f4cf94}
    #t3jb .promo .box{max-width:1280px;margin:0 auto;padding:8px 16px;display:flex;gap:12px;align-items:center}
    #t3jb .ticker{overflow:hidden; white-space:nowrap; flex:1; mask-image:linear-gradient(90deg,transparent,black 8%,black 92%,transparent);}
    #t3jb .track{display:inline-block; padding-left:100%; will-change:transform; animation:ticker 24s linear infinite;}
    @keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
    #t3jb .promo .msg{display:inline-block; margin-right:28px; color:#5b3b00; font-weight:600}
    #t3jb .promo .msg a{color:#7a4b00}

    /* Layout principal con sidebar */
    #t3jb main{padding:24px 0}
    #t3jb .layout{display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:1100px){#t3jb .layout{grid-template-columns:280px 1fr}}
    #t3jb aside{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:14px;position:relative}
    #t3jb .aside-title{font-weight:800;margin:0 0 8px 0}
    #t3jb .aside-section{margin-bottom:14px}
    #t3jb .aside-list{list-style:none;margin:0;padding:0;max-height:320px;overflow:auto}
    #t3jb .aside-list li{margin:0;padding:4px 0}
    #t3jb .aside-list a{display:block;padding:6px 8px;border-radius:8px}
    #t3jb .aside-list a:hover{background:#f3f4f6;text-decoration:none}

    /* Toggle de sidebar en m√≥vil */
    #t3jb .aside-toggle{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    #t3jb .btn-filter{display:inline-flex;align-items:center;gap:6px}
    @media(min-width:1100px){#t3jb .btn-filter{display:none}}

    /* Encabezado de lista */
    #t3jb .list-head{display:flex;align-items:center;justify-content:space-between;margin:10px 0 16px 0;gap:8px;flex-wrap:wrap}
    #t3jb .count{font-weight:700;color:#0e4a77}
    #t3jb .hint{font-size:12px;color:#6b7280}

    /* Grilla de tarjetas */
    #t3jb .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:700px){#t3jb .grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1200px){#t3jb .grid{grid-template-columns:repeat(3,1fr)}}

    /* Tarjetas */
    #t3jb .card{background:#fff;border-radius:18px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.08);display:flex;flex-direction:column;gap:12px}
    #t3jb .badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:6px 10px;border-radius:999px;font-size:12px}
    #t3jb .title{font-size:18px;font-weight:800;margin:0}
    #t3jb .title a{color:inherit}
    #t3jb .muted{color:#6b7280;font-size:13px}
    #t3jb .salary{display:flex;align-items:center;gap:8px;font-weight:700;color:#0b3c5d}
    #t3jb .coin{width:18px;height:18px;display:inline-block}
    #t3jb .desc{font-size:14px}
    #t3jb .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
    #t3jb .empty{text-align:center;background:#fff;border-radius:18px;padding:28px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    #t3jb footer{padding:24px 0;color:#6b7280;font-size:13px}

    /* Indicadores */
    #t3jb .status-row{display:flex;align-items:center;gap:10px}
    #t3jb .status-pill{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
    #t3jb .progress{position:relative;width:100%;height:8px;border-radius:999px;background:#eef2f7;overflow:hidden}
    #t3jb .progress .fill{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:999px;background:linear-gradient(90deg,#16a34a,#f59e0b,#7c3aed)}
    #t3jb .owner{display:flex;align-items:center;gap:8px}
    #t3jb .avatar{width:30px;height:30px;border-radius:999px;display:grid;place-items:center;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    #t3jb .avatar svg{width:18px;height:18px;display:block}

    /* Modal */
    #t3jb .modal-backdrop{position:fixed;inset:0;background:rgba(17,24,39,.6);display:none;z-index:300}
    #t3jb .modal-backdrop.show{display:grid;place-items:center;animation:fadeIn .18s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    #t3jb .modal{background:#fff;max-width:760px;width:92vw;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    #t3jb .modal header{background:linear-gradient(135deg,#0b3c5d 0%, #102a43 100%);color:#fff;position:relative}
    #t3jb .modal header .wrap{padding:14px 18px}
    #t3jb .modal .close{position:absolute;top:10px;right:12px;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.4);border-radius:10px;padding:6px 10px;cursor:pointer}
    #t3jb .modal .body{padding:16px 18px;max-height:74vh;overflow:auto}
    #t3jb .modal .meta{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
    #t3jb .modal .badge{background:#eef2ff;color:#3730a3}
    #t3jb .modal .actions{margin-top:12px}

    /* Form embebido */
    #t3jb .formWrap{display:none;margin-top:12px}
    #t3jb .formWrap iframe{width:100%;height:680px;border:0;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    #t3jb .formFallback{margin-top:8px;font-size:13px;color:#6b7280}

    /* Paginaci√≥n */
    #t3jb .pager{display:flex;justify-content:center;margin:18px 0}

    /* Mejoras m√≥viles */
    @media(max-width:600px){
      #t3jb .wrap{padding:12px}
      #t3jb .card{padding:16px}
      #t3jb .title{font-size:17px}
      #t3jb .desc{font-size:15px}
      #t3jb .salary{font-size:15px}
      #t3jb .brand img{height:44px}
    }

    /* Otros utilitarios */
    #t3jb .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08);transform:translateY(16px);opacity:0;pointer-events:none;transition:.25s ease;z-index:400}
    #t3jb .toast.show{transform:translateY(0);opacity:1;pointer-events:auto}
    #t3jb .topbtn{position:fixed;right:16px;bottom:16px;background:#0b3c5d;color:#fff;border:0;border-radius:999px;width:46px;height:46px;display:grid;place-items:center;box-shadow:0 8px 24px rgba(0,0,0,.08);cursor:pointer;display:none;z-index:350}
  </style>

  <a class="sr-only" href="#t3jb-contenido">Saltar al contenido</a>

  <div class="t3-header">
    <div class="wrap">
      <div class="nav">
        <div class="brand">
          <!-- LOGO CLICABLE -->
          <a class="logo" href="https://talento3.com/" aria-label="Ir a Talento 3.0">
            <img src="https://talento3.com/wp-content/uploads/2024/04/LogoT3.png" alt="Logo Talento 3.0" />
          </a>
          <div class="headtext">
            <h1>Executive JobBoard | Vacantes Disponibles</h1>
            <div class="date" id="t3jb-dateNow">Fecha: ‚Äî</div>
          </div>
        </div>
        <div class="head-actions">
          <div class="stats"><span>Vacantes:</span><strong id="t3jb-total">0</strong></div>
          <a href="https://talento3.com/" class="btn ghost small" aria-label="Regresar a Talento 3.0">Regresar a Talento 3.0</a>
        </div>
      </div>

      <div class="toolbar" aria-label="Filtros de b√∫squeda">
        <div class="searchWrap">
          <input class="input" id="t3jb-q" type="search" placeholder="Buscar por palabras: puesto, descripci√≥n, lugar‚Ä¶" aria-label="Buscar palabras clave">
          <button class="btn secondary tiny" id="t3jb-doSearch" title="Ejecutar b√∫squeda" aria-label="Ejecutar b√∫squeda">üîé</button>
        </div>
        <select id="t3jb-city" aria-label="Filtrar por ciudad">
          <option value="">Todas las ciudades</option>
        </select>
        <!-- Ordenar -->
        <select id="t3jb-sort" aria-label="Ordenar resultados">
          <option value="dateDesc">Ordenar: Recientes</option>
          <option value="dateAsc">Ordenar: Antiguas</option>
          <option value="salaryDesc">Sueldo: mayor a menor</option>
          <option value="salaryAsc">Sueldo: menor a mayor</option>
          <option value="az">A‚ÄìZ (puesto)</option>
          <option value="za">Z‚ÄìA (puesto)</option>
        </select>
        <button class="btn" id="t3jb-refresh" title="Recargar datos">Actualizar</button>
        <button class="btn ghost" id="t3jb-toList" title="Ir a listado">Listado</button>
      </div>

      <div class="legend">
        <span class="dot new"><i></i> Nuevas</span>
        <span class="dot int"><i></i> Entrevistas</span>
        <span class="dot fin"><i></i> Finalistas</span>
      </div>
    </div>

    <div class="promo" aria-label="Informaci√≥n comercial Talento 3.0">
      <div class="box">
        <div class="ticker"><div id="t3jb-promoTrack" class="track"></div></div>
      </div>
    </div>
  </div>

  <main class="wrap" id="t3jb-contenido">
    <div class="layout">
      <!-- Sidebar (izquierda en desktop, arriba en m√≥vil) -->
      <aside id="t3jb-aside">
        <div class="aside-toggle">
          <h3 class="aside-title" style="margin:0">Explora r√°pido</h3>
          <button id="t3jb-asideToggle" class="btn secondary btn-filter" aria-expanded="false">‚ò∞ Filtros r√°pidos</button>
        </div>

        <div class="aside-inner">
          <div class="aside-section">
            <h4 class="aside-title">Categor√≠as</h4>
            <ul id="t3jb-cats" class="aside-list"></ul>
          </div>
          <div class="aside-section">
            <h4 class="aside-title">Regiones</h4>
            <ul id="t3jb-regions" class="aside-list"></ul>
          </div>
        </div>
      </aside>

      <!-- Listado -->
      <section style="min-width:0">
        <div class="list-head">
          <div class="count" id="t3jb-count">Mostrando 0 de 0 vacantes</div>
          <div class="hint">Consejo: filtra por ciudad y usa ‚ÄúM√°s info‚Äù para ver la descripci√≥n completa.</div>
        </div>

        <section id="t3jb-cards" class="grid" aria-live="polite"></section>
        <div id="t3jb-pager" class="pager" style="display:none">
          <button class="btn secondary" id="t3jb-loadMore">Cargar m√°s</button>
        </div>

        <div id="t3jb-empty" class="empty" style="display:none">
          <h3>No pude encontrar <code>positions.csv</code></h3>
          <p id="t3jb-emptyMsg">Verifica que el CSV sea accesible. Si usas el puente, abre: <code>https://talento3.com/?t3_csv=empleos</code> (ajusta el host para que coincida con esta p√°gina).</p>
          <button class="btn" id="t3jb-retry">Reintentar</button>
        </div>

        <div id="t3jb-schemaDump" style="display:none"></div>
      </section>
    </div>
  </main>

  <footer class="wrap" style="padding:24px 0;color:#6b7280;font-size:13px">
    ¬© <span id="t3jb-year"></span> Talento 3.0. Portal administrado por <strong>administrador</strong>. ¬∑ Optimizado para SEO y Google Jobs.
  </footer>

  <button id="t3jb-topBtn" class="topbtn" aria-label="Volver arriba" title="Volver arriba">‚Üë</button>
  <div id="t3jb-toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Modal -->
  <div id="t3jb-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="t3jb-modalTitle">
      <header>
        <div class="wrap">
          <button class="close" id="t3jb-modalClose" aria-label="Cerrar">‚úï</button>
          <h2 id="t3jb-modalTitle" style="margin:0;font-size:18px">Vacante</h2>
        </div>
      </header>
      <div class="body">
        <div class="meta" id="t3jb-modalMeta"></div>
        <div class="status-row" style="margin-bottom:8px">
          <span class="status-pill" id="t3jb-modalStatus"></span>
          <div class="progress" aria-hidden="true" style="flex:1;max-width:360px"><div class="fill" id="t3jb-modalProg"></div></div>
        </div>
        <div class="desc" id="t3jb-modalShort"></div>
        <div id="t3jb-modalFull" style="white-space:pre-wrap; margin-top:8px; display:none" class="desc"></div>
        <button class="btn secondary" id="t3jb-modalToggle" style="margin-top:8px">Ver m√°s</button>

        <!-- Formulario embebido -->
        <div class="formWrap" id="t3jb-formWrap">
          <iframe id="t3jb-formFrame" src="" title="Formulario de aplicaci√≥n"></iframe>
          <div class="formFallback" id="t3jb-formFallback" style="display:none">
            Si el formulario no se visualiza, puedes abrirlo aqu√≠:
            <a id="t3jb-formLink" href="#" target="_blank" rel="noopener">Abrir formulario</a>
          </div>
        </div>

        <div class="actions">
          <button id="t3jb-modalApply" class="btn">Aplicar</button>
          <a id="t3jb-modalShareWA" class="btn secondary" href="#" target="_blank" rel="noopener" title="WhatsApp (compartir con un amigo o conocido)">WhatsApp (compartir con un amigo)</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Agente IA (Jotform) -->
<script src="https://cdn.jotfor.ms/agent/embedjs/0199263e5f5a7199a83430be0e855bd38fa8/embed.js"></script>

<script>
(() => {
  const root = document.getElementById('t3jb');
  const $ = sel => root.querySelector(sel);
  const $$ = sel => Array.from(root.querySelectorAll(sel));

  // Bloquea rutas file://
  const srcCsv = root.dataset.csv || '';
  if (/^file:/i.test(srcCsv)) {
    const box = $('#t3jb-empty');
    const msg = $('#t3jb-emptyMsg');
    if (box && msg) {
      box.style.display = 'block';
      msg.innerHTML = 'No se puede cargar CSV desde <code>file://</code>. Usa una URL <code>https://</code> del mismo dominio (ej. <code>https://' + location.host + '/?t3_csv=empleos</code>).';
    }
    throw new Error('CSV file:// not allowed');
  }

  const showToast = (msg, ok=false) => { const t = $('#t3jb-toast'); t.textContent = msg; t.style.background = ok ? 'linear-gradient(135deg,#15803d,#16a34a)' : '#111827'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2400); };
  const sanitize = (s='') => String(s ?? '').trim();
  const escapeHtml = (s='') => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const slugify = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  const PALETTE=['#0ea5e9','#f97316','#22c55e','#a855f7','#ef4444','#10b981','#8b5cf6','#f59e0b','#14b8a6','#e11d48'];
  const ownerColor = (seed='') => { const str = seed || 'owner'; const hash = [...str].reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0),0); return PALETTE[Math.abs(hash)%PALETTE.length]; };
  const statusFromId = (id) => { const hash=[...id].reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0),0); const idx=Math.abs(hash)%3; const labels=['Nueva','Entrevistas','Finalistas']; return { idx, label:labels[idx], progress:Math.round(((idx+1)/3)*100) }; };

  // Sueldo $8,500 MXN
  const formatWithCommas = (n) => String(n||'').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  const parseWholeAmount = (raw) => { if(raw == null) return null; const s = String(raw).replace(/\s+/g,''); const m = s.match(/(\d{1,3}(?:[.,]\d{3})+|\d+)(?:[.,](\d{1,2}))?/); if(!m) return null; const whole = m[1].replace(/[^\d]/g,''); return whole && /^\d+$/.test(whole) ? whole : null; };
  const salaryPrettyFromCSV = raw => { const w = parseWholeAmount(raw); return w ? ('$'+formatWithCommas(w)+' MXN') : 'No especificado'; };
  const extractNumber = raw => { const w=parseWholeAmount(raw); return w ? parseInt(w,10) : undefined; };
  const coinSVG = () => `<svg class="coin" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="#ffd166"/><circle cx="12" cy="12" r="8" fill="#fbbf24"/><path d="M9 9.5h5.5M9 14.5h5.5M12 7v10" stroke="#8a5a00" stroke-width="1.5" stroke-linecap="round"/></svg>`;

  // Descripci√≥n corta 25% (m√°x 1000)
  const shortByPercent = (s, pct=0.25, max=1000) => { if(!s) return ''; const len=s.length; let n=Math.max(1,Math.floor(len*pct)); n=Math.min(n,max); return n>=len ? s : s.slice(0,n)+'‚Ä¶'; };

  // Fechas
  const parseDate = (s) => { const d = new Date(s || ''); return isNaN(d) ? null : d; };

  // CSV robusto
  function parseCSV(text){
    text = String(text || '').replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n');
    if (!text.trim()) return [];
    const firstLine = text.split('\n').find(l => l.trim().length) || '';
    const candidates = [',',';','\t','|'];
    const countOf = (line, d) => (line.match(new RegExp('\\' + d, 'g')) || []).length;
    let best = candidates[0], bestCount = -1;
    for (const d of candidates){ const c = countOf(firstLine, d); if (c > bestCount){ best = d; bestCount = c; } }
    function parseWith(delim){
      const rows=[]; let i=0, field='', row=[], inQ=false;
      const pushF=()=>{ row.push(field); field=''; }; const pushR=()=>{ rows.push(row); row=[]; };
      while(i<text.length){
        const ch=text[i];
        if(inQ){ if(ch === '"'){ if(text[i+1] === '"'){ field+='"'; i+=2; continue; } inQ=false; i++; continue; } field+=ch; i++; continue; }
        if(ch === '"'){ inQ=true; i++; continue; }
        if(ch === delim){ pushF(); i++; continue; }
        if(ch === '\n'){ pushF(); pushR(); i++; continue; }
        field += ch; i++;
      }
      if(field!=='' || row.length){ pushF(); pushR(); }
      return rows;
    }
    let table = parseWith(best);
    if (table.length && table[0].length < 2){
      for (const d of candidates){ if (d===best) continue; const t=parseWith(d); if (t[0] && t[0].length>1){ table=t; best=d; break; } }
    }
    if (!table.length) return [];
    const headers = table[0].map(h=>String(h??'').trim());
    const dataRows = table.slice(1).filter(r=>r.some(x=>String(x??'').trim()!==''));
    return dataRows.map(r=>{ const o={}; headers.forEach((h,i)=>o[h]= r[i]!==undefined? r[i]:'' ); return o; });
  }

  // URLs a probar
  function csvUrls(){
    const fromAttr = root.dataset.csv && String(root.dataset.csv).trim();
    const absolute = (() => { if(!fromAttr) return null; try { return new URL(fromAttr, location.origin).toString(); } catch { return fromAttr; }})();
    return [ absolute, 'positions.csv' ].filter(Boolean);
  }
  async function tryFetch(url){
    const useCacheBust = (root.dataset.cache ?? 'true') !== 'false';
    const finalUrl = useCacheBust ? (url + (url.includes('?') ? '&' : '?') + 't=' + Date.now()) : url;
    const res = await fetch(finalUrl, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    if(!text || !text.trim()) throw new Error('CSV vac√≠o');
    return text;
  }

  // Estado
  const state = { jobs: [], filtered: [], current:null, page:1, pageSize:12, lastFocus: null };

  function normalizeRows(rows){
    const norm=s=>String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[:]/g,'').replace(/\s+/g,' ').trim();
    const idx={}; Object.keys(rows[0]).forEach(h=>{ idx[norm(h)]=h; });
    const H=raw=>idx[norm(raw)] ?? raw;

    return rows.map((r,i)=>{
      const puesto=sanitize(r[H('Puesto')]);
      const ciudad=sanitize(r[H('Ciudad')]);
      const lugar=sanitize(r[H('Lugar centro de trabajo')]);
      const sueldo=sanitize(r[H('Sueldo Mensual')]);
      const creacion=sanitize(r[H('Creacion')]); // ordenar s√≥lo
      const infoFull=sanitize(r[H('Informaci√≥n de la Vacante:')] || r[H('Informaci√≥n de la Vacante')]);
      const link=sanitize(r[H('Link para aplicar a vacante')]);
      const titular=sanitize(r[H('Titular')]); // avatar por color
      const id=`${slugify(puesto||'vacante')}-${i+1}`;
      const status=statusFromId(id);
      const infoShort=shortByPercent(infoFull,0.25,1000);
      const color=ownerColor(titular);
      const createdAt=parseDate(creacion);
      const salaryNum = extractNumber(sueldo) || 0;
      return { id, puesto, ciudad, lugar, sueldo, creacion, createdAt, salaryNum, infoFull, infoShort, link, titular, status, color };
    });
  }

  function setHeaderDate(){
    const now=new Date();
    const long=now.toLocaleDateString('es-MX',{day:'numeric',month:'long',year:'numeric'});
    $('#t3jb-dateNow').textContent='Fecha: '+long.charAt(0).toUpperCase()+long.slice(1);
    $('#t3jb-year').textContent=now.getFullYear();
  }
  function buildPromo(){
    const track=$('#t3jb-promoTrack'); track.innerHTML='';
    const span=document.createElement('span'); span.className='msg';
    span.textContent = [
      "Informaci√≥n y Ventas (800) 00 106 89",
      "Escr√≠benos: info@talento3.com",
      "Visita: www.talento3.com"
    ].join('   ‚Ä¢   ');
    track.appendChild(span);
  }

  // -------- Sidebar: categor√≠as y regiones --------
  const CAT_RULES = [
    {key:'Ventas', rx:/\b(ventas?|comercial|account|ejecutiv[oa]|kpi|crm)\b/i},
    {key:'Finanzas', rx:/\b(finanzas?|contab|tesorer|cobranz|fiscal|auditor)\b/i},
    {key:'RH', rx:/\b(recursos humanos|rh|talento|recluta|nomina|capacita)\b/i},
    {key:'Tecnolog√≠a', rx:/\b(software|desarroll|tech|ti|it|sistemas|data|devops|soporte)\b/i},
    {key:'Operaciones', rx:/\b(operacion|produccion|plant[a|e]|mantenimiento|calidad|lean)\b/i},
    {key:'Log√≠stica', rx:/\b(logistic|almacen|suministro|cadena|transporte|rutas)\b/i},
    {key:'Marketing', rx:/\b(marketing|mercadotecnia|brand|contenido|seo|social|growth)\b/i},
    {key:'Legal', rx:/\b(legal|juridic|compliance|contratos?)\b/i},
  ];
  function inferCategory(title){
    for(const r of CAT_RULES){ if(r.rx.test(title||'')) return r.key; }
    return 'Otros';
  }

  function buildSidebar(data){
    // Categor√≠as
    const byCat = {};
    data.forEach(j=>{
      const cat = inferCategory(j.puesto);
      (byCat[cat] = byCat[cat] || []).push(j);
    });
    const catKeys = Object.keys(byCat).sort((a,b)=>a.localeCompare(b,'es'));
    $('#t3jb-cats').innerHTML = catKeys.map(k=>{
      const n=byCat[k].length;
      return `<li><a href="#" data-filter-cat="${escapeHtml(k)}">${escapeHtml(k)} (${n})</a></li>`;
    }).join('');

    // Regiones (ciudades)
    const regions = [...new Set(data.map(j=>j.ciudad).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
    $('#t3jb-regions').innerHTML = regions.map(c=>`<li><a href="#" data-filter-region="${escapeHtml(c)}">${escapeHtml(c)}</a></li>`).join('');

    // Eventos
    $('#t3jb-cats').querySelectorAll('[data-filter-cat]').forEach(a=>{
      a.addEventListener('click',(e)=>{
        e.preventDefault();
        const cat = e.currentTarget.getAttribute('data-filter-cat');
        $('#t3jb-q').value = '';
        $('#t3jb-city').value = '';
        state.page = 1;
        state.filtered = state.jobs.filter(j=>inferCategory(j.puesto)===cat);
        renderList(state.filtered);
        closeAsideMobile();
      });
    });
    $('#t3jb-regions').querySelectorAll('[data-filter-region]').forEach(a=>{
      a.addEventListener('click',(e)=>{
        e.preventDefault();
        const region = e.currentTarget.getAttribute('data-filter-region');
        $('#t3jb-q').value = '';
        $('#t3jb-city').value = region;
        applyFilters();
        closeAsideMobile();
      });
    });
  }

  function openAsideMobile(){
    const btn = $('#t3jb-asideToggle');
    const inner = $('#t3jb-aside .aside-inner');
    inner.style.display='block';
    btn.setAttribute('aria-expanded','true');
  }
  function closeAsideMobile(){
    const btn = $('#t3jb-asideToggle');
    const inner = $('#t3jb-aside .aside-inner');
    if (window.matchMedia('(max-width: 1099px)').matches){
      inner.style.display='none';
      btn.setAttribute('aria-expanded','false');
    } else {
      inner.style.display='block';
      btn.setAttribute('aria-expanded','true');
    }
  }

  // -------- Ordenamiento --------
  function sortItems(arr){
    const mode = $('#t3jb-sort').value || 'dateDesc';
    const byTitle = (a,b)=> (a.puesto||'').localeCompare(b.puesto||'', 'es');
    const byDate = (a,b)=> ((b.createdAt?.getTime()||0) - (a.createdAt?.getTime()||0));
    const byDateAsc = (a,b)=> ((a.createdAt?.getTime()||0) - (b.createdAt?.getTime()||0));
    const bySal = (a,b)=> (b.salaryNum - a.salaryNum);
    const bySalAsc = (a,b)=> (a.salaryNum - b.salaryNum);
    const copy = [...arr];
    switch(mode){
      case 'dateAsc': copy.sort(byDateAsc); break;
      case 'salaryDesc': copy.sort(bySal); break;
      case 'salaryAsc': copy.sort(bySalAsc); break;
      case 'az': copy.sort(byTitle); break;
      case 'za': copy.sort((a,b)=>byTitle(b,a)); break;
      default: copy.sort(byDate); // dateDesc
    }
    return copy;
  }

  // -------- Paginaci√≥n --------
  const stateUI = { page:1, pageSize:12 };
  function getPaged(items){
    const end = stateUI.page * stateUI.pageSize;
    const slice = items.slice(0, end);
    const hasMore = end < items.length;
    $('#t3jb-pager').style.display = hasMore ? 'flex' : 'none';
    return slice;
  }

  // Render de tarjetas
  function updateStats(show,total){
    $('#t3jb-total').textContent = total;
    $('#t3jb-count').textContent = `Mostrando ${show} de ${total} vacantes`;
  }
  function waMessage(j){ return `Creo que este empleo te puede interesar: ${j.puesto} üíº\nAplica aqu√≠: ${j.link} ‚ú®üì≤`; }
  function waHref(j){ return j?.link ? `https://api.whatsapp.com/send?text=${encodeURIComponent(waMessage(j))}` : null; }

  function renderList(items){
    const wrap=$('#t3jb-cards'); wrap.innerHTML='';
    if(!items.length){ $('#t3jb-empty').style.display = state.jobs.length ? 'none':'block'; updateStats(0,state.jobs.length); return; }
    $('#t3jb-empty').style.display='none';

    const sorted = sortItems(items);
    const paged = getPaged(sorted);

    const frag=document.createDocumentFragment();
    paged.forEach(j=>{
      const statusPct=j.status.progress, statusLbl=j.status.label;
      const shareWA = waHref(j);
      const shareBtn = shareWA
        ? `<a class="btn secondary" href="${shareWA}" target="_blank" rel="noopener" title="WhatsApp (compartir con un amigo o conocido)">WhatsApp (compartir con un amigo)</a>`
        : `<button class="btn secondary" disabled title="No hay enlace para aplicar">WhatsApp (compartir)</button>`;

      const applyBtn = j.link
        ? `<button class="btn" data-open-apply="${j.id}">Aplicar</button>`
        : `<button class="btn" disabled>Aplicar</button>`;

      const card=document.createElement('article'); card.className='card';
      card.innerHTML = `
        <div class="badge">${escapeHtml(j.ciudad || 'Ubicaci√≥n no especificada')}</div>
        <h3 class="title"><a href="#/job/${encodeURIComponent(j.id)}" data-open-info="${j.id}">${escapeHtml(j.puesto || 'Puesto no especificado')}</a></h3>
        <div class="muted">${escapeHtml(j.lugar || 'Centro de trabajo no especificado')}</div>

        <div class="owner" title="Ejecutivo/a asignado">
          <div class="avatar" style="background:${j.color}">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <circle cx="12" cy="12" r="10" fill="rgba(255,255,255,.2)"/>
              <circle cx="9" cy="10" r="1.2" fill="#fff"/><circle cx="15" cy="10" r="1.2" fill="#fff"/>
              <path d="M7.5 14a4.5 4.5 0 0 0 9 0" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
          </div>
        </div>

        <div class="status-row">
          <span class="status-pill">Estado: ${escapeHtml(statusLbl)}</span>
          <div class="progress" aria-hidden="true"><div class="fill" style="width:${statusPct}%"></div></div>
        </div>

        <div class="salary">${coinSVG()} <span>Sueldo mensual: ${salaryPrettyFromCSV(j.sueldo)}</span></div>

        <p class="desc">${escapeHtml(j.infoShort || '')}</p>

        <div class="actions">
          ${applyBtn}
          <button class="btn secondary" data-open-info="${j.id}">M√°s info</button>
          ${shareBtn}
        </div>
      `;
      frag.appendChild(card);
    });
    wrap.appendChild(frag);

    // Listeners de modal
    wrap.querySelectorAll('[data-open-info]').forEach(el=>el.addEventListener('click', (e)=>{
      e.preventDefault();
      state.lastFocus = e.currentTarget;
      const id=e.currentTarget.getAttribute('data-open-info');
      const job=state.jobs.find(x=>x.id===id); if(job){ openModal(job,'info'); location.hash = '#/job/'+encodeURIComponent(id); }
    }));
    wrap.querySelectorAll('[data-open-apply]').forEach(el=>el.addEventListener('click', (e)=>{
      e.preventDefault();
      state.lastFocus = e.currentTarget;
      const id=e.currentTarget.getAttribute('data-open-apply');
      const job=state.jobs.find(x=>x.id===id); if(job){ openModal(job,'apply'); location.hash = '#/job/'+encodeURIComponent(id); }
    }));

    updateStats(paged.length, state.jobs.length);
    injectSchemas(paged);
  }

  // Modal + Form embebido
  function showForm(job){
    const wrap = $('#t3jb-formWrap');
    const frame = $('#t3jb-formFrame');
    const fallback = $('#t3jb-formFallback');
    const link = $('#t3jb-formLink');

    if(job.link){
      frame.src = job.link;
      link.href = job.link;
      wrap.style.display = 'block';
      fallback.style.display = 'none';

      // Si el proveedor bloquea el embed, mostramos fallback tras 2.5s si el frame no se carga
      let loaded = false;
      const onLoad = ()=>{ loaded = true; fallback.style.display = 'none'; };
      frame.addEventListener('load', onLoad, { once:true });
      setTimeout(()=>{ if(!loaded){ fallback.style.display = 'block'; } }, 2500);
      
      // Scroll dentro del modal hacia el formulario
      setTimeout(()=>{ frame.scrollIntoView({behavior:'smooth', block:'start'}); }, 100);
    } else {
      wrap.style.display = 'none';
      fallback.style.display = 'none';
      showToast('No hay enlace para aplicar en esta vacante.');
    }
  }
  function hideForm(){
    const wrap = $('#t3jb-formWrap');
    const frame = $('#t3jb-formFrame');
    wrap.style.display = 'none';
    frame.src = '';
  }

  function openModal(job, mode='info'){
    state.current = job;
    $('#t3jb-modalTitle').textContent = job.puesto || 'Vacante';
    $('#t3jb-modalMeta').innerHTML = `
      <span class="badge">${escapeHtml(job.ciudad || 'Ubicaci√≥n')}</span>
      <span class="badge">${coinSVG()} <span>${salaryPrettyFromCSV(job.sueldo)}</span></span>
    `;
    $('#t3jb-modalStatus').textContent = 'Estado: ' + job.status.label;
    $('#t3jb-modalProg').style.width = job.status.progress + '%';
    $('#t3jb-modalShort').textContent = job.infoShort || '';
    $('#t3jb-modalFull').textContent = job.infoFull || '';
    $('#t3jb-modalFull').style.display = 'none';
    $('#t3jb-modalToggle').textContent = 'Ver m√°s';
    hideForm();

    const wa = job.link ? `https://api.whatsapp.com/send?text=${encodeURIComponent(\`Creo que este empleo te puede interesar: \${job.puesto} üíº\\nAplica aqu√≠: \${job.link} ‚ú®üì≤\`)}` : null;
    const waBtn = $('#t3jb-modalShareWA');
    if(wa){ waBtn.href = wa; waBtn.removeAttribute('aria-disabled'); }
    else{ waBtn.href = '#'; waBtn.setAttribute('aria-disabled','true'); }

    showModal();
    if(mode==='apply'){ showForm(job); }
  }
  function showModal(){ const m=$('#t3jb-modal'); m.classList.add('show'); m.removeAttribute('aria-hidden'); document.body.style.overflow='hidden'; }
  function closeModal(){ const m=$('#t3jb-modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; hideForm(); if(state.lastFocus){ state.lastFocus.focus(); } }

  $('#t3jb-modalToggle').addEventListener('click', ()=>{
    const full=$('#t3jb-modalFull');
    const isOpen = full.style.display!=='none';
    if(isOpen){ full.style.display='none'; $('#t3jb-modalToggle').textContent='Ver m√°s'; }
    else { full.style.display='block'; $('#t3jb-modalToggle').textContent='Ver menos'; }
  });
  $('#t3jb-modalApply').addEventListener('click', ()=>{
    if(state.current){ showForm(state.current); }
  });
  $('#t3jb-modalClose').addEventListener('click', ()=>{ closeModal(); history.replaceState(null,'',location.pathname+location.search); });
  $('#t3jb-modal').addEventListener('click', (e)=>{ if(e.target.id==='t3jb-modal') { closeModal(); history.replaceState(null,'',location.pathname+location.search); } });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeModal(); history.replaceState(null,'',location.pathname+location.search); } });

  // Hash routing para abrir directamente un job
  function handleHashRoute(){
    const h=location.hash||'';
    const m=h.match(/^#\/job\/(.+)$/);
    if(m){
      const id=decodeURIComponent(m[1]);
      const job=state.jobs.find(j=>j.id===id);
      if(job) openModal(job,'info');
    }
  }
  window.addEventListener('hashchange', handleHashRoute);

  // Schema JobPosting (SEO)
  const isoDate=s=>{ const d=new Date(s||Date.now()); return isNaN(d.getTime())?new Date().toISOString():d.toISOString(); };
  function validThrough(creacion){ const d=new Date(creacion||Date.now()); return new Date((isNaN(d)?Date.now():d.getTime()) + 60*24*3600*1000).toISOString(); }
  function injectSchemas(items){
    const dump=$('#t3jb-schemaDump'); dump.innerHTML='';
    items.forEach(j=>{
      const payload={
        "@context":"https://schema.org/","@type":"JobPosting","title": j.puesto || "Vacante",
        "description": (j.infoFull||'').replace(/\n/g,'<br>'),
        "datePosted": isoDate(j.creacion),
        "employmentType":"FULL_TIME",
        "hiringOrganization":{"@type":"Organization","name":"Talento 3.0","sameAs":"https://talento3.com","logo":"https://talento3.com/wp-content/uploads/2024/04/LogoT3.png"},
        "jobLocation":{"@type":"Place","address":{"@type":"PostalAddress","addressLocality": j.ciudad || "M√©xico","streetAddress": j.lugar || ""}},
        "directApply": true,"validThrough": validThrough(j.creacion),
        "baseSalary": j.sueldo ? {"@type":"MonetaryAmount","currency":"MXN","value":{"@type":"QuantitativeValue","value": extractNumber(j.sueldo),"unitText":"MONTH"}} : undefined,
        "applicantLocationRequirements":{"@type":"Country","name":"MX"}
      };
      const s=document.createElement('script'); s.type='application/ld+json'; s.textContent=JSON.stringify(payload); dump.appendChild(s);
    });
  }

  // Filtros + Orden + Paginaci√≥n
  function applyFilters(){
    const q=$('#t3jb-q').value.trim().toLowerCase();
    const city=$('#t3jb-city').value.trim().toLowerCase();
    stateUI.page = 1; // reset paginaci√≥n
    state.filtered = state.jobs.filter(j=>{
      const okCity=!city || (j.ciudad||'').toLowerCase()===city;
      const txt=[j.puesto,j.infoFull,j.lugar,j.ciudad,j.sueldo,j.titular].join(' ').toLowerCase();
      const okQ=!q || txt.includes(q);
      return okCity && okQ;
    });
    renderList(state.filtered);
  }

  // Carga CSV
  async function loadCSV(){
    const candidates = csvUrls();
    let text = null;
    for(const u of candidates){
      try{ text = await tryFetch(u); break; }
      catch(e){ console.warn('CSV fail', u, e); }
    }
    if(!text){
      $('#t3jb-empty').style.display='block';
      $('#t3jb-cards').innerHTML='';
      updateStats(0,0); injectSchemas([]);
      const tried = candidates.map(u=>`<li><code>${u}</code></li>`).join('');
      $('#t3jb-emptyMsg').innerHTML = `No se pudo cargar el CSV. Prob√© estas rutas:<ul>${tried}</ul>
      <p>Abre una de ellas en inc√≥gnito. Si alguna carga, usa esa misma en <code>data-csv</code> (mismo host que esta p√°gina: <code>${location.origin}</code>).</p>`;
      return;
    }
    const rows = parseCSV(text);
    state.jobs = normalizeRows(rows);

    // Inicializar UI y MOSTRAR TODO desde el arranque
    setHeaderDate(); buildPromo();
    buildSidebar(state.jobs);
    populateCities();
    state.filtered = [...state.jobs];         // ‚üµ muestra todas al cargar
    renderList(state.filtered);               // ‚üµ render inmediato
    $('#t3jb-empty').style.display='none';
    showToast('Vacantes cargadas', true);
    handleHashRoute();
  }

  function populateCities(){
    const cities=[...new Set(state.jobs.map(j=>j.ciudad).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
    $('#t3jb-city').innerHTML = `<option value="">Todas las ciudades</option>` + cities.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  }

  // Eventos UI
  $('#t3jb-q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') applyFilters(); });
  $('#t3jb-doSearch').addEventListener('click', applyFilters);
  $('#t3jb-city').addEventListener('change', applyFilters);
  $('#t3jb-sort').addEventListener('change', ()=>{ renderList(state.filtered); });
  $('#t3jb-refresh').addEventListener('click', loadCSV);
  $('#t3jb-retry').addEventListener('click', loadCSV);
  $('#t3jb-toList').addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); });

  // Paginaci√≥n: Cargar m√°s
  $('#t3jb-loadMore').addEventListener('click', ()=>{
    stateUI.page++;
    renderList(state.filtered);
  });

  // Toggle sidebar m√≥vil
  $('#t3jb-asideToggle').addEventListener('click', ()=>{
    const btn = $('#t3jb-asideToggle');
    const inner = $('#t3jb-aside .aside-inner');
    const open = btn.getAttribute('aria-expanded') === 'true';
    if(open){ inner.style.display='none'; btn.setAttribute('aria-expanded','false'); }
    else { inner.style.display='block'; btn.setAttribute('aria-expanded','true'); }
  });
  // Mostrar/ocultar seg√∫n ancho
  closeAsideMobile();
  window.addEventListener('resize', closeAsideMobile);

  // Top button
  const topBtn=$('#t3jb-topBtn');
  window.addEventListener('scroll', ()=>{ topBtn.style.display = window.scrollY>500 ? 'grid':'none'; });
  topBtn.addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));

  // Init
  setHeaderDate(); buildPromo(); loadCSV();
})();
</script>
