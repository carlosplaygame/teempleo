<!doctype html>
<html lang="es" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Executive JobBoard | Vacantes Disponibles</title>
  <meta name="description" content="Vacantes abiertas. Filtra, busca y aplica.">
  <link rel="icon" href="https://talento3.com/wp-content/uploads/2025/09/Logo-Talento-3.0-FAVICON.001.png" />
  <style>
    /* ======= Estilos encapsulados ======= */
    :root{--t3p:#0b3c5d;--t3p600:#0e4a77;--acc:#f39c12;--bg:#f6f8fb;--card:#fff;--txt:#1b1f23;--mut:#6b7280}
    html,body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:var(--t3p600);text-decoration:none} a:hover{text-decoration:underline}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    .t3-header{background:linear-gradient(135deg,var(--t3p) 0%, #102a43 100%);color:#fff;position:sticky;top:0;z-index:60;box-shadow:0 4px 18px rgba(0,0,0,.15)}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .nav{display:flex;align-items:center;gap:16px;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .brand a.logo{display:inline-flex;align-items:center}
    .brand img{height:48px;width:auto;border-radius:8px;background:#fff;padding:6px}
    .headtext{display:flex;flex-direction:column;gap:2px}
    .headtext h1{margin:0;font-size:18px;letter-spacing:.2px}
    .headtext .date{font-size:13px;opacity:.9}
    .stats{display:flex;align-items:center;gap:8px;color:#fff;font-size:14px;opacity:.95}
    .head-actions{display:flex;align-items:center;gap:12px}

    .toolbar{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){.toolbar{grid-template-columns:2.2fr 1.1fr 1.1fr auto auto}}
    .input, select{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:12px 14px;outline:none;box-shadow:inset 0 1px 0 rgba(0,0,0,.02);font-size:14px}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:.15s transform ease,.15s box-shadow ease;box-shadow:0 8px 24px rgba(0,0,0,.08);background:var(--acc);color:#1b1f23}
    .btn.secondary{background:#fff;color:var(--t3p);border:1px solid #e5e7eb}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.35);box-shadow:none}
    .btn:hover{transform:translateY(-1px)}
    .btn.small{padding:8px 12px;font-size:13px;border-radius:10px}
    .searchWrap{display:grid;grid-template-columns:1fr 44px;align-items:stretch}
    .searchWrap .input{border-radius:12px 0 0 12px;border-right:0}
    .searchWrap .btn.tiny{border-radius:0 12px 12px 0;height:100%;padding:0;display:grid;place-items:center;min-width:44px}

    .promo{background:linear-gradient(90deg,#fff 0%, #fff7ec 35%, #ffe4b8 100%); border-top:1px solid #f4cf94; border-bottom:1px solid #f4cf94}
    .promo .box{max-width:1280px;margin:0 auto;padding:8px 16px;display:flex;gap:12px;align-items:center}
    .ticker{overflow:hidden; white-space:nowrap; flex:1; mask-image:linear-gradient(90deg,transparent,black 8%,black 92%,transparent);}
    .track{display:inline-block; padding-left:100%; will-change:transform; animation:ticker 24s linear infinite;}
    @keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
    .promo .msg{display:inline-block; margin-right:28px; color:#5b3b00; font-weight:600}
    .promo .msg a{color:#7a4b00}

    main{padding:24px 0}
    .layout{display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:1100px){.layout{grid-template-columns:300px 1fr}}
    aside{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:14px}
    .aside-title{font-weight:800;margin:0 0 8px 0}
    .aside-section{margin-bottom:18px}
    .aside-list{list-style:none;margin:0;padding:0;max-height:320px;overflow:auto}
    .aside-list li{margin:0;padding:4px 0}
    .aside-list a{display:block;padding:6px 8px;border-radius:8px}
    .aside-list a:hover{background:#f3f4f6;text-decoration:none}
    .chart{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px}
    .chart h5{margin:0 0 8px 0;font-size:13px;color:#374151}
    canvas{width:100%;height:160px;display:block}
    .quotes{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px}
    .quote{font-size:13px;color:#374151;margin:0 0 10px 0}
    .quote small{display:block;color:#6b7280;margin-top:4px}
    .aside-toggle{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .btn-filter{display:inline-flex;align-items:center;gap:6px}
    @media(min-width:1100px){.btn-filter{display:none}}

    .list-head{display:flex;align-items:center;justify-content:space-between;margin:10px 0 16px 0;gap:8px;flex-wrap:wrap}
    .count{font-weight:700;color:var(--t3p600)}
    .hint{font-size:12px;color:var(--mut)}

    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:700px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1200px){.grid{grid-template-columns:repeat(3,1fr)}}

    .card{background:#fff;border-radius:18px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.08);display:flex;flex-direction:column;gap:12px}
    .badge{display:inline-block;background:#eef2ff;color:#3730a3;padding:6px 10px;border-radius:999px;font-size:12px}
    .title{font-size:18px;font-weight:800;margin:0}
    .title a{color:inherit}
    .muted{color:var(--mut);font-size:13px}
    .salary{display:flex;align-items:center;gap:8px;font-weight:700;color:var(--t3p)}
    .coin{width:18px;height:18px;display:inline-block}
    .desc{font-size:14px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
    .empty{text-align:center;background:#fff;border-radius:18px;padding:28px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    footer{padding:24px 0;color:var(--mut);font-size:13px}

    .status-row{display:flex;align-items:center;gap:10px}
    .status-pill{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
    .progress{position:relative;width:100%;height:8px;border-radius:999px;background:#eef2f7;overflow:hidden}
    .progress .fill{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:999px;background:linear-gradient(90deg,#16a34a,#f59e0b,#7c3aed)}
    .owner{display:flex;align-items:center;gap:8px}
    .avatar{width:30px;height:30px;border-radius:999px;display:grid;place-items:center;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    .avatar svg{width:18px;height:18px;display:block}

    .modal-backdrop{position:fixed;inset:0;background:rgba(17,24,39,.6);display:none;z-index:300}
    .modal-backdrop.show{display:grid;place-items:center;animation:fadeIn .18s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{background:#fff;max-width:760px;width:92vw;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    .modal header{background:linear-gradient(135deg,var(--t3p) 0%, #102a43 100%);color:#fff;position:relative}
    .modal header .wrap{padding:14px 18px}
    .modal .close{position:absolute;top:10px;right:12px;background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.4);border-radius:10px;padding:6px 10px;cursor:pointer}
    .modal .body{padding:16px 18px;max-height:74vh;overflow:auto}
    .modal .meta{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
    .modal .badge{background:#eef2ff;color:#3730a3}
    .modal .actions{margin-top:12px}

    .formWrap{display:none;margin-top:12px}
    .formWrap iframe{width:100%;height:760px;border:0;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    @media(max-width:600px){.formWrap iframe{height:520px}}
    .formFallback{margin-top:8px;font-size:13px;color:var(--mut)}

    .pager{display:flex;justify-content:center;margin:18px 0}

    @media(max-width:600px){
      .wrap{padding:12px}
      .card{padding:16px}
      .title{font-size:17px}
      .desc{font-size:15px}
      .salary{font-size:15px}
      .brand img{height:44px}
    }

    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08);transform:translateY(16px);opacity:0;pointer-events:none;transition:.25s ease;z-index:400}
    .toast.show{transform:translateY(0);opacity:1;pointer-events:auto}
    .topbtn{position:fixed;right:16px;bottom:16px;background:var(--t3p);color:#fff;border:0;border-radius:999px;width:46px;height:46px;display:grid;place-items:center;box-shadow:0 8px 24px rgba(0,0,0,.08);cursor:pointer;display:none;z-index:350}
  </style>
</head>
<body>
  <a class="sr-only" href="#contenido">Saltar al contenido</a>

  <div class="t3-header">
    <div class="wrap">
      <div class="nav">
        <div class="brand">
          <a class="logo" href="https://talento3.com/" aria-label="Ir a Talento 3.0">
            <img src="https://talento3.com/wp-content/uploads/2024/04/LogoT3.png" alt="Logo Talento 3.0" />
          </a>
          <div class="headtext">
            <h1>Executive JobBoard | Vacantes Disponibles</h1>
            <div class="date" id="dateNow">Fecha: —</div>
          </div>
        </div>
        <div class="head-actions">
          <div class="stats"><span>Vacantes:</span><strong id="total">0</strong></div>
          <a href="https://talento3.com/" class="btn ghost small" aria-label="Regresar a Talento 3.0">Regresar a Talento 3.0</a>
        </div>
      </div>

      <div class="toolbar" aria-label="Filtros de búsqueda">
        <div class="searchWrap">
          <input class="input" id="q" type="search" placeholder="Buscar por palabras: puesto, descripción, lugar…" aria-label="Buscar palabras clave">
          <button class="btn secondary tiny" id="doSearch" title="Ejecutar búsqueda" aria-label="Ejecutar búsqueda">🔎</button>
        </div>
        <select id="city" aria-label="Filtrar por ciudad">
          <option value="">Todas las ciudades</option>
        </select>
        <select id="sort" aria-label="Ordenar resultados">
          <option value="dateDesc">Ordenar: Recientes</option>
          <option value="dateAsc">Ordenar: Antiguas</option>
          <option value="salaryDesc">Sueldo: mayor a menor</option>
          <option value="salaryAsc">Sueldo: menor a mayor</option>
          <option value="az">A–Z (puesto)</option>
          <option value="za">Z–A (puesto)</option>
        </select>
        <button class="btn" id="refresh" title="Recargar datos">Actualizar</button>
        <button class="btn ghost" id="toList" title="Ir a listado">Listado</button>
      </div>

      <div class="legend" style="margin-top:8px">
        <span class="dot new"><i style="display:inline-block;width:10px;height:10px;border-radius:999px;background:#16a34a;margin-right:6px"></i> Nuevas</span>
        <span class="dot int"><i style="display:inline-block;width:10px;height:10px;border-radius:999px;background:#f59e0b;margin:0 6px 0 14px"></i> Entrevistas</span>
        <span class="dot fin"><i style="display:inline-block;width:10px;height:10px;border-radius:999px;background:#7c3aed;margin:0 6px 0 14px"></i> Finalistas</span>
      </div>
    </div>

    <div class="promo" aria-label="Información comercial Talento 3.0">
      <div class="box">
        <div class="ticker"><div id="promoTrack" class="track"></div></div>
      </div>
    </div>
  </div>

  <main class="wrap" id="contenido">
    <div class="layout">
      <aside id="aside">
        <div class="aside-toggle">
          <h3 class="aside-title" style="margin:0">Explora rápido</h3>
          <button id="asideToggle" class="btn secondary btn-filter" aria-expanded="false">☰ Filtros rápidos</button>
        </div>

        <div class="aside-inner">
          <div class="aside-section">
            <h4 class="aside-title">Categorías</h4>
            <ul id="cats" class="aside-list"></ul>
          </div>
          <div class="aside-section">
            <h4 class="aside-title">Regiones</h4>
            <ul id="regions" class="aside-list"></ul>
          </div>

          <div class="aside-section chart">
            <h5>Especialidades más buscadas</h5>
            <canvas id="chartCats"></canvas>
          </div>
          <div class="aside-section chart">
            <h5>Vacantes por región (Top 8)</h5>
            <canvas id="chartCities"></canvas>
          </div>
          <div class="aside-section chart">
            <h5>Distribución de sueldos</h5>
            <canvas id="chartSalary"></canvas>
          </div>

          <div class="aside-section quotes">
            <p class="quote">“Proceso claro y rápido; encontré candidatos calificados en menos de una semana.”<small>Gerente de Operaciones</small></p>
            <p class="quote">“Las vacantes se posicionan muy bien y recibimos postulaciones relevantes.”<small>Directora de RH</small></p>
            <p class="quote">“El seguimiento con IA mejoró la tasa de respuesta de los candidatos.”<small>Líder de Selección</small></p>
          </div>
        </div>
      </aside>

      <section style="min-width:0">
        <div class="list-head">
          <div class="count" id="countLabel">Mostrando 0 de 0 vacantes</div>
          <div class="hint">Consejo: filtra por ciudad y usa “Más info” para ver la descripción completa.</div>
        </div>

        <section id="cards" class="grid" aria-live="polite"></section>
        <div id="pager" class="pager" style="display:none">
          <button class="btn secondary" id="loadMore">Cargar más</button>
        </div>

        <div id="empty" class="empty" style="display:none">
          <h3>No pude cargar <code>positions.csv</code></h3>
          <p id="emptyMsg">Si abriste este archivo como <code>file://</code>, muchos navegadores bloquean la lectura directa. Opciones:
          <br>1) Usa el botón <strong>Cargar positions.csv</strong> para seleccionarlo manualmente.
          <br>2) Inicia un servidor local y abre <code>http://localhost:8000</code> (por ejemplo: <code>python -m http.server</code>).
          </p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
            <button class="btn" id="retry">Reintentar</button>
            <button class="btn secondary" id="pickCsv">Cargar positions.csv</button>
            <input type="file" id="fileInput" accept=".csv,text/csv" style="display:none">
          </div>
        </div>

        <div id="schemaDump" style="display:none"></div>
      </section>
    </div>
  </main>

  <footer class="wrap">
    © <span id="year"></span> Talento 3.0. Portal administrado por <strong>administrador</strong>. · Optimizado para SEO y Google Jobs.
  </footer>

  <button id="topBtn" class="topbtn" aria-label="Volver arriba" title="Volver arriba">↑</button>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <div class="wrap">
          <button class="close" id="modalClose" aria-label="Cerrar">✕</button>
          <h2 id="modalTitle" style="margin:0;font-size:18px">Vacante</h2>
        </div>
      </header>
      <div class="body">
        <div class="meta" id="modalMeta"></div>
        <div class="status-row" style="margin-bottom:8px">
          <span class="status-pill" id="modalStatus"></span>
          <div class="progress" aria-hidden="true" style="flex:1;max-width:360px"><div class="fill" id="modalProg"></div></div>
        </div>
        <div class="desc" id="modalShort"></div>
        <div id="modalFull" style="white-space:pre-wrap; margin-top:8px; display:none" class="desc"></div>
        <button class="btn secondary" id="modalToggle" style="margin-top:8px">Ver más</button>

        <div class="formWrap" id="formWrap">
          <iframe id="formFrame" src="" title="Formulario de aplicación"></iframe>
          <div class="formFallback" id="formFallback" style="display:none">
            Si el formulario no se visualiza, puedes abrirlo aquí:
            <a id="formLink" href="#" target="_blank" rel="noopener">Abrir formulario</a>
          </div>
        </div>

        <div class="actions">
          <button id="modalApply" class="btn">Aplicar</button>
          <a id="modalShareWA" class="btn secondary" href="#" target="_blank" rel="noopener" title="WhatsApp (compartir con un amigo o conocido)">WhatsApp (compartir con un amigo)</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Agente IA (Jotform) -->
  <script src="https://cdn.jotfor.ms/agent/embedjs/0199263e5f5a7199a83430be0e855bd38fa8/embed.js"></script>

  <script>
  (() => {
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const showToast = (msg, ok=false) => { const t=$('#toast'); t.textContent=msg; t.style.background=ok?'linear-gradient(135deg,#15803d,#16a34a)':'#111827'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2400); };
    const sanitize = (s='')=>String(s??'').trim();
    const escapeHtml = (s='')=>s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const slugify = s=>s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const PALETTE=['#0ea5e9','#f97316','#22c55e','#a855f7','#ef4444','#10b981','#8b5cf6','#f59e0b','#14b8a6','#e11d48'];
    const ownerColor = (seed='') => { const str=seed||'owner'; const hash=[...str].reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0),0); return PALETTE[Math.abs(hash)%PALETTE.length]; };
    const statusFromId = (id)=>{ const hash=[...id].reduce((a,c)=>((a<<5)-a)+c.charCodeAt(0),0); const idx=Math.abs(hash)%3; const labels=['Nueva','Entrevistas','Finalistas']; return { idx, label:labels[idx], progress:Math.round(((idx+1)/3)*100) }; };

    // Sueldo $8,500 MXN
    const formatWithCommas = (n)=> String(n||'').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    const parseWholeAmount = (raw)=>{ if(raw==null) return null; const s=String(raw).replace(/\s+/g,''); const m=s.match(/(\d{1,3}(?:[.,]\d{3})+|\d+)(?:[.,](\d{1,2}))?/); if(!m) return null; const whole=m[1].replace(/[^\d]/g,''); return whole && /^\d+$/.test(whole)?whole:null; };
    const salaryPrettyFromCSV = raw => { const w=parseWholeAmount(raw); return w ? ('$'+formatWithCommas(w)+' MXN') : 'No especificado'; };
    const extractNumber = raw => { const w=parseWholeAmount(raw); return w ? parseInt(w,10):undefined; };
    const coinSVG = ()=>`<svg class="coin" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="#ffd166"/><circle cx="12" cy="12" r="8" fill="#fbbf24"/><path d="M9 9.5h5.5M9 14.5h5.5M12 7v10" stroke="#8a5a00" stroke-width="1.5" stroke-linecap="round"/></svg>`;

    const shortByPercent=(s,pct=0.25,max=1000)=>{ if(!s) return ''; const len=s.length; let n=Math.max(1,Math.floor(len*pct)); n=Math.min(n,max); return n>=len?s:s.slice(0,n)+'…'; };
    const parseDate = (s)=>{ const d=new Date(s||''); return isNaN(d)?null:d; };

    function setHeaderDate(){ const now=new Date(); const long=now.toLocaleDateString('es-MX',{day:'numeric',month:'long',year:'numeric'}); $('#dateNow').textContent='Fecha: '+long.charAt(0).toUpperCase()+long.slice(1); $('#year').textContent=now.getFullYear(); }
    function buildPromo(){ const track=$('#promoTrack'); track.innerHTML=''; const span=document.createElement('span'); span.className='msg'; span.textContent=["Información y Ventas (800) 00 106 89","Escríbenos: info@talento3.com","Visita: www.talento3.com"].join('   •   '); track.appendChild(span); }

    // CSV parser tolerante a separadores , ; \t |
    function parseCSV(text){
      text = String(text || '').replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n');
      if (!text.trim()) return [];
      const firstLine = text.split('\n').find(l => l.trim().length) || '';
      const candidates = [',',';','\t','|'];
      const countOf = (line, d) => (line.match(new RegExp('\\' + d, 'g')) || []).length;
      let best = candidates[0], bestCount = -1;
      for (const d of candidates){ const c = countOf(firstLine, d); if (c > bestCount){ best = d; bestCount = c; } }
      function parseWith(delim){
        const rows=[]; let i=0, field='', row=[], inQ=false;
        const pushF=()=>{ row.push(field); field=''; }; const pushR=()=>{ rows.push(row); row=[]; };
        while(i<text.length){
          const ch=text[i];
          if(inQ){ if(ch === '"'){ if(text[i+1] === '"'){ field+='"'; i+=2; continue; } inQ=false; i++; continue; } field+=ch; i++; continue; }
          if(ch === '"'){ inQ=true; i++; continue; }
          if(ch === delim){ pushF(); i++; continue; }
          if(ch === '\n'){ pushF(); pushR(); i++; continue; }
          field += ch; i++;
        }
        if(field!=='' || row.length){ pushF(); pushR(); }
        return rows;
      }
      let table = parseWith(best);
      if (table.length && table[0].length < 2){
        for (const d of candidates){ if (d===best) continue; const t=parseWith(d); if (t[0] && t[0].length>1){ table=t; best=d; break; } }
      }
      if (!table.length) return [];
      const headers = table[0].map(h=>String(h??'').trim());
      const dataRows = table.slice(1).filter(r=>r.some(x=>String(x??'').trim()!==''));
      return dataRows.map(r=>{ const o={}; headers.forEach((h,i)=>o[h]= r[i]!==undefined? r[i]:'' ); return o; });
    }

    // Normalización de filas a nuestro esquema
    function normalizeRows(rows){
      const norm=s=>String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[:]/g,'').replace(/\s+/g,' ').trim();
      const idx={}; Object.keys(rows[0]).forEach(h=>{ idx[norm(h)]=h; });
      const H=raw=>idx[norm(raw)] ?? raw;

      return rows.map((r,i)=>{
        const puesto=sanitize(r[H('Puesto')]);
        const ciudad=sanitize(r[H('Ciudad')]);
        const lugar=sanitize(r[H('Lugar centro de trabajo')]);
        const sueldo=sanitize(r[H('Sueldo Mensual')]);
        const creacion=sanitize(r[H('Creacion')]);
        const infoFull=sanitize(r[H('Información de la Vacante:')] || r[H('Información de la Vacante')]);
        const link=sanitize(r[H('Link para aplicar a vacante')]);
        const titular=sanitize(r[H('Titular')]);
        const id=`${slugify(puesto||'vacante')}-${i+1}`;
        const status=statusFromId(id);
        const infoShort=shortByPercent(infoFull,0.25,1000);
        const color=ownerColor(titular);
        const createdAt=parseDate(creacion);
        const salaryNum = extractNumber(sueldo) || 0;
        return { id, puesto, ciudad, lugar, sueldo, creacion, createdAt, salaryNum, infoFull, infoShort, link, titular, status, color };
      });
    }

    // Estado global
    const state = { jobs: [], filtered: [], current:null };
    const stateUI = { page:1, pageSize:12 };

    // Sidebar categorías/ciudades
    const CAT_RULES = [
      {key:'Ventas', rx:/\b(ventas?|comercial|account|ejecutiv[oa]|kpi|crm)\b/i},
      {key:'Finanzas', rx:/\b(finanzas?|contab|tesorer|cobranz|fiscal|auditor)\b/i},
      {key:'RH', rx:/\b(recursos humanos|rh|talento|recluta|nomina|capacita)\b/i},
      {key:'Tecnología', rx:/\b(software|desarroll|tech|ti|it|sistemas|data|devops|soporte)\b/i},
      {key:'Operaciones', rx:/\b(operacion|produccion|plant[a|e]|mantenimiento|calidad|lean)\b/i},
      {key:'Logística', rx:/\b(logistic|almacen|suministro|cadena|transporte|rutas)\b/i},
      {key:'Marketing', rx:/\b(marketing|mercadotecnia|brand|contenido|seo|social|growth)\b/i},
      {key:'Legal', rx:/\b(legal|juridic|compliance|contratos?)\b/i},
    ];
    const inferCategory = title => { for(const r of CAT_RULES){ if(r.rx.test(title||'')) return r.key; } return 'Otros'; };

    function buildSidebar(data){
      // Categorías
      const byCat = {};
      data.forEach(j=>{ const c=inferCategory(j.puesto); byCat[c]=(byCat[c]||0)+1; });
      const catItems = Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
      $('#cats').innerHTML = catItems.map(([k,n])=>`<li><a href="#" data-filter-cat="${escapeHtml(k)}">${escapeHtml(k)} (${n})</a></li>`).join('');
      // Regiones
      const regions = [...new Set(data.map(j=>j.ciudad).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
      $('#regions').innerHTML = regions.map(c=>`<li><a href="#" data-filter-region="${escapeHtml(c)}">${escapeHtml(c)}</a></li>`).join('');

      // Eventos
      $('#cats').querySelectorAll('[data-filter-cat]').forEach(a=>a.addEventListener('click',(e)=>{
        e.preventDefault(); const cat=e.currentTarget.getAttribute('data-filter-cat');
        $('#q').value=''; $('#city').value=''; stateUI.page=1;
        state.filtered = state.jobs.filter(j=>inferCategory(j.puesto)===cat);
        renderList(state.filtered); updateCharts(state.filtered);
      }));
      $('#regions').querySelectorAll('[data-filter-region]').forEach(a=>a.addEventListener('click',(e)=>{
        e.preventDefault(); const region=e.currentTarget.getAttribute('data-filter-region');
        $('#q').value=''; $('#city').value=region; applyFilters();
      }));
    }

    // Charts (canvas simple)
    function drawBarChart(canvas, labels, values, {maxBars=8, padding=12}={}){
      if(!canvas) return; const ctx=canvas.getContext('2d');
      const W=canvas.clientWidth, H=canvas.clientHeight; canvas.width=W; canvas.height=H;
      ctx.clearRect(0,0,W,H); if(!values.length) return;
      const n=Math.min(values.length,maxBars), data=values.slice(0,n), labs=labels.slice(0,n);
      const maxV=Math.max(...data)||1; const barW=(W-padding*2)/n*0.7; const step=(W-padding*2)/n;
      ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      data.forEach((v,i)=>{ const x=padding+i*step+(step-barW)/2; const h=(H-40)*(v/maxV); const y=H-24-h;
        ctx.fillStyle='#0b3c5d'; ctx.fillRect(x,y,barW,h);
        ctx.fillStyle='#111827'; ctx.fillText(String(v),x,y-4);
        ctx.fillStyle='#6b7280'; const lab=labs[i].length>10?labs[i].slice(0,10)+'…':labs[i]; ctx.fillText(lab,x,H-8);
      });
    }
    function histogram(vals,bins=6){
      if(!vals.length) return {edges:[],counts:[]};
      const min=Math.min(...vals), max=Math.max(...vals), span=Math.max(1,max-min), step=Math.ceil(span/bins);
      const edges=Array.from({length:bins},(_,i)=>min+i*step); const counts=new Array(bins).fill(0);
      vals.forEach(v=>{ const idx=Math.min(bins-1,Math.floor((v-min)/step)); counts[idx]++; });
      return {edges,counts};
    }
    function updateCharts(items){
      const byCat={}; items.forEach(j=>{ const c=inferCategory(j.puesto); byCat[c]=(byCat[c]||0)+1; });
      const cats=Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
      drawBarChart($('#chartCats'), cats.map(x=>x[0]), cats.map(x=>x[1]), {maxBars:8});

      const byCity={}; items.forEach(j=>{ const c=j.ciudad||'—'; byCity[c]=(byCity[c]||0)+1; });
      const cities=Object.entries(byCity).sort((a,b)=>b[1]-a[1]);
      drawBarChart($('#chartCities'), cities.map(x=>x[0]), cities.map(x=>x[1]), {maxBars:8});

      const sueldos=items.map(j=>j.salaryNum).filter(Boolean);
      const {edges,counts}=histogram(sueldos,6);
      const labels=edges.map((e,i)=>{ const next=edges[i+1]||Math.max(...sueldos, e); return `$${(e||0).toLocaleString('es-MX')}–$${(next||0).toLocaleString('es-MX')}`; });
      drawBarChart($('#chartSalary'), labels, counts, {maxBars:6});
    }

    // Paginación
    function getPaged(items){ const end=stateUI.page*stateUI.pageSize; const slice=items.slice(0,end); const more=end<items.length; $('#pager').style.display=more?'flex':'none'; return slice; }
    function updateStats(show,total){ $('#total').textContent=total; $('#countLabel').textContent=`Mostrando ${show} de ${total} vacantes`; }

    // WhatsApp
    const waMessage = j => `Creo que este empleo te puede interesar: ${j.puesto} 💼\nAplica aquí: ${j.link} ✨📲`;
    const waHref = j => j?.link ? `https://api.whatsapp.com/send?text=${encodeURIComponent(waMessage(j))}` : null;

    function coinSVG(){ return `<svg class="coin" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" fill="#ffd166"/><circle cx="12" cy="12" r="8" fill="#fbbf24"/><path d="M9 9.5h5.5M9 14.5h5.5M12 7v10" stroke="#8a5a00" stroke-width="1.5" stroke-linecap="round"/></svg>`; }

    // Render listado
    function renderList(items){
      const wrap=$('#cards'); wrap.innerHTML='';
      if(!items.length){ $('#empty').style.display = state.jobs.length ? 'none':'block'; updateStats(0,state.jobs.length); return; }
      $('#empty').style.display='none';

      const sorted = sortItems(items);
      const paged = getPaged(sorted);
      const frag=document.createDocumentFragment();

      paged.forEach(j=>{
        const statusPct=j.status.progress, statusLbl=j.status.label;
        const shareWA=waHref(j);
        const shareBtn = shareWA ? `<a class="btn secondary" href="${shareWA}" target="_blank" rel="noopener" title="WhatsApp (compartir con un amigo o conocido)">WhatsApp (compartir con un amigo)</a>` : `<button class="btn secondary" disabled>WhatsApp (compartir)</button>`;
        const applyBtn = j.link ? `<button class="btn" data-open-apply="${j.id}">Aplicar</button>` : `<button class="btn" disabled>Aplicar</button>`;

        const card=document.createElement('article'); card.className='card';
        card.innerHTML = `
          <div class="badge">${escapeHtml(j.ciudad || 'Ubicación no especificada')}</div>
          <h3 class="title"><a href="#/job/${encodeURIComponent(j.id)}" data-open-info="${j.id}">${escapeHtml(j.puesto || 'Puesto no especificado')}</a></h3>
          <div class="muted">${escapeHtml(j.lugar || 'Centro de trabajo no especificado')}</div>

          <div class="owner" title="Ejecutivo/a asignado">
            <div class="avatar" style="background:${j.color}">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10" fill="rgba(255,255,255,.2)"/>
                <circle cx="9" cy="10" r="1.2" fill="#fff"/><circle cx="15" cy="10" r="1.2" fill="#fff"/>
                <path d="M7.5 14a4.5 4.5 0 0 0 9 0" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round"/>
              </svg>
            </div>
          </div>

          <div class="status-row">
            <span class="status-pill">Estado: ${escapeHtml(statusLbl)}</span>
            <div class="progress" aria-hidden="true"><div class="fill" style="width:${statusPct}%"></div></div>
          </div>

          <div class="salary">${coinSVG()} <span>Sueldo mensual: ${salaryPrettyFromCSV(j.sueldo)}</span></div>

          <p class="desc">${escapeHtml(j.infoShort || '')}</p>

          <div class="actions">
            ${applyBtn}
            <button class="btn secondary" data-open-info="${j.id}">Más info</button>
            ${shareBtn}
          </div>
        `;
        frag.appendChild(card);
      });
      wrap.appendChild(frag);

      wrap.querySelectorAll('[data-open-info]').forEach(el=>el.addEventListener('click',(e)=>{
        e.preventDefault(); const id=e.currentTarget.getAttribute('data-open-info'); const job=state.jobs.find(x=>x.id===id); if(job){ openModal(job,'info'); location.hash='#/job/'+encodeURIComponent(id); }
      }));
      wrap.querySelectorAll('[data-open-apply]').forEach(el=>el.addEventListener('click',(e)=>{
        e.preventDefault(); const id=e.currentTarget.getAttribute('data-open-apply'); const job=state.jobs.find(x=>x.id===id); if(job){ openModal(job,'apply'); location.hash='#/job/'+encodeURIComponent(id); }
      }));

      updateStats(paged.length, state.jobs.length);
      injectSchemas(paged);
    }

    // Ordenamiento
    function sortItems(arr){
      const mode=$('#sort').value || 'dateDesc';
      const byTitle=(a,b)=> (a.puesto||'').localeCompare(b.puesto||'','es');
      const byDate=(a,b)=> ((b.createdAt?.getTime()||0)-(a.createdAt?.getTime()||0));
      const byDateAsc=(a,b)=> ((a.createdAt?.getTime()||0)-(b.createdAt?.getTime()||0));
      const bySal=(a,b)=> (b.salaryNum - a.salaryNum);
      const bySalAsc=(a,b)=> (a.salaryNum - b.salaryNum);
      const copy=[...arr];
      switch(mode){
        case 'dateAsc': copy.sort(byDateAsc); break;
        case 'salaryDesc': copy.sort(bySal); break;
        case 'salaryAsc': copy.sort(bySalAsc); break;
        case 'az': copy.sort(byTitle); break;
        case 'za': copy.sort((a,b)=>byTitle(b,a)); break;
        default: copy.sort(byDate);
      }
      return copy;
    }

    // Filtros
    function populateCities(){
      const cities=[...new Set(state.jobs.map(j=>j.ciudad).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
      $('#city').innerHTML=`<option value="">Todas las ciudades</option>`+cities.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    }
    function applyFilters(){
      const q=$('#q').value.trim().toLowerCase();
      const city=$('#city').value.trim().toLowerCase();
      stateUI.page=1;
      state.filtered=state.jobs.filter(j=>{
        const okCity=!city || (j.ciudad||'').toLowerCase()===city;
        const txt=[j.puesto,j.infoFull,j.lugar,j.ciudad,j.sueldo,j.titular].join(' ').toLowerCase();
        const okQ=!q || txt.includes(q);
        return okCity && okQ;
      });
      renderList(state.filtered);
      updateCharts(state.filtered);
    }

    // Modal + formulario
    function showModal(){ const m=$('#modal'); m.classList.add('show'); m.removeAttribute('aria-hidden'); document.body.style.overflow='hidden'; }
    function closeModal(){ const m=$('#modal'); m.classList.remove('show'); m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; hideForm(); }
    function showForm(job){
      const wrap=$('#formWrap'), frame=$('#formFrame'), fb=$('#formFallback'), link=$('#formLink');
      if(job.link){ frame.src=job.link; link.href=job.link; wrap.style.display='block'; fb.style.display='none';
        let loaded=false; const onLoad=()=>{loaded=true; fb.style.display='none';}; frame.addEventListener('load',onLoad,{once:true});
        setTimeout(()=>{ if(!loaded) fb.style.display='block'; },2500);
        setTimeout(()=>{ frame.scrollIntoView({behavior:'smooth',block:'start'}); },100);
      } else { wrap.style.display='none'; fb.style.display='none'; showToast('No hay enlace para aplicar.'); }
    }
    function hideForm(){ const wrap=$('#formWrap'), frame=$('#formFrame'); wrap.style.display='none'; frame.src=''; }
    function openModal(job, mode='info'){
      state.current=job;
      $('#modalTitle').textContent=job.puesto||'Vacante';
      $('#modalMeta').innerHTML=`<span class="badge">${escapeHtml(job.ciudad||'Ubicación')}</span> <span class="badge">${coinSVG()} <span>${salaryPrettyFromCSV(job.sueldo)}</span></span>`;
      $('#modalStatus').textContent='Estado: '+job.status.label;
      $('#modalProg').style.width=job.status.progress+'%';
      $('#modalShort').textContent=job.infoShort||'';
      $('#modalFull').textContent=job.infoFull||''; $('#modalFull').style.display='none'; $('#modalToggle').textContent='Ver más';
      const wa=job.link?`https://api.whatsapp.com/send?text=${encodeURIComponent(\`Creo que este empleo te puede interesar: \${job.puesto} 💼\\nAplica aquí: \${job.link} ✨📲\`)}`:null;
      const waBtn=$('#modalShareWA'); if(wa){ waBtn.href=wa; waBtn.removeAttribute('aria-disabled'); } else { waBtn.href='#'; waBtn.setAttribute('aria-disabled','true'); }
      showModal(); if(mode==='apply') showForm(job);
    }

    $('#modalToggle').addEventListener('click',()=>{ const full=$('#modalFull'); const open=full.style.display!=='none'; if(open){ full.style.display='none'; $('#modalToggle').textContent='Ver más'; } else { full.style.display='block'; $('#modalToggle').textContent='Ver menos'; } });
    $('#modalApply').addEventListener('click',()=>{ if(state.current) showForm(state.current); });
    $('#modalClose').addEventListener('click',()=>{ closeModal(); history.replaceState(null,'',location.pathname+location.search); });
    $('#modal').addEventListener('click',(e)=>{ if(e.target.id==='modal'){ closeModal(); history.replaceState(null,'',location.pathname+location.search); } });
    window.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ closeModal(); history.replaceState(null,'',location.pathname+location.search); } });

    function handleHashRoute(){
      const h=location.hash||''; const m=h.match(/^#\/job\/(.+)$/);
      if(m){ const id=decodeURIComponent(m[1]); const job=state.jobs.find(j=>j.id===id); if(job) openModal(job,'info'); }
    }
    window.addEventListener('hashchange', handleHashRoute);

    // JSON-LD
    const isoDate=s=>{ const d=new Date(s||Date.now()); return isNaN(d.getTime())?new Date().toISOString():d.toISOString(); };
    function validThrough(creacion){ const d=new Date(creacion||Date.now()); return new Date((isNaN(d)?Date.now():d.getTime())+60*24*3600*1000).toISOString(); }
    function injectSchemas(items){
      const dump=$('#schemaDump'); dump.innerHTML='';
      items.forEach(j=>{
        const payload={"@context":"https://schema.org/","@type":"JobPosting","title": j.puesto || "Vacante",
          "description": (j.infoFull||'').replace(/\n/g,'<br>'),"datePosted": isoDate(j.creacion),"employmentType":"FULL_TIME",
          "hiringOrganization":{"@type":"Organization","name":"Talento 3.0","sameAs":"https://talento3.com","logo":"https://talento3.com/wp-content/uploads/2024/04/LogoT3.png"},
          "jobLocation":{"@type":"Place","address":{"@type":"PostalAddress","addressLocality": j.ciudad || "México","streetAddress": j.lugar || ""}},
          "directApply": true,"validThrough": validThrough(j.creacion),
          "baseSalary": j.sueldo ? {"@type":"MonetaryAmount","currency":"MXN","value":{"@type":"QuantitativeValue","value": extractNumber(j.sueldo),"unitText":"MONTH"}} : undefined,
          "applicantLocationRequirements":{"@type":"Country","name":"MX"}};
        const s=document.createElement('script'); s.type='application/ld+json'; s.textContent=JSON.stringify(payload); dump.appendChild(s);
      });
    }

    // Gráficos: actualización según items
    function updateChartsWrapper(){ updateCharts(state.filtered||[]); }

    // Eventos UI
    $('#q').addEventListener('keydown',(e)=>{ if(e.key==='Enter') applyFilters(); });
    $('#doSearch').addEventListener('click', applyFilters);
    $('#city').addEventListener('change', applyFilters);
    $('#sort').addEventListener('change', ()=> renderList(state.filtered) );
    $('#refresh').addEventListener('click', ()=> loadCSV() );
    $('#retry').addEventListener('click', ()=> loadCSV() );
    $('#toList').addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); });
    $('#loadMore').addEventListener('click', ()=>{ stateUI.page++; renderList(state.filtered); });

    // Sidebar móvil
    function closeAsideMobile(){
      const btn=$('#asideToggle'); const inner=$('#aside .aside-inner');
      if (window.matchMedia('(max-width: 1099px)').matches){ inner.style.display='none'; btn.setAttribute('aria-expanded','false'); }
      else { inner.style.display='block'; btn.setAttribute('aria-expanded','true'); }
    }
    $('#asideToggle').addEventListener('click', ()=>{
      const btn=$('#asideToggle'); const inner=$('#aside .aside-inner'); const open=btn.getAttribute('aria-expanded')==='true';
      if(open){ inner.style.display='none'; btn.setAttribute('aria-expanded','false'); } else { inner.style.display='block'; btn.setAttribute('aria-expanded','true'); }
    });
    window.addEventListener('resize', ()=>{ closeAsideMobile(); updateChartsWrapper(); });

    // Top button
    const topBtn=$('#topBtn');
    window.addEventListener('scroll', ()=>{ topBtn.style.display = window.scrollY>500 ? 'grid':'none'; });
    topBtn.addEventListener('click', ()=>window.scrollTo({top:0,behavior:'smooth'}));

    // ------- Carga CSV (HTTP) + Fallback (file:// selector) -------
    const CSV_DEFAULT = 'positions.csv';
    function csvCandidates(){ return [CSV_DEFAULT]; }
    async function tryFetch(url){
      const finalUrl = url + (url.includes('?')? '&':'?') + 't=' + Date.now();
      const res = await fetch(finalUrl, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      if(!text || !text.trim()) throw new Error('CSV vacío');
      return text;
    }

    async function loadCSV(){
      const isFile = location.protocol === 'file:';
      if(isFile){
        // file:// — pedir archivo al usuario
        $('#empty').style.display='block';
        $('#cards').innerHTML='';
        updateStats(0,0);
        $('#emptyMsg').innerHTML = 'Estás viendo este portal como <code>file://</code>. Para continuar, pulsa <strong>Cargar positions.csv</strong> y selecciona el archivo en esta misma carpeta.';
        return;
      }

      // http/https: intentar cargar automáticamente
      const candidates = csvCandidates();
      let text=null;
      for(const u of candidates){
        try{ text = await tryFetch(u); break; } catch(e){ console.warn('CSV fail', u, e); }
      }
      if(!text){
        $('#empty').style.display='block';
        $('#cards').innerHTML='';
        updateStats(0,0);
        $('#emptyMsg').innerHTML = `No se pudo cargar <code>${CSV_DEFAULT}</code> desde esta ruta. Asegúrate de que <strong>${CSV_DEFAULT}</strong> está en la misma carpeta que este archivo HTML y vuelve a intentar.`;
        return;
      }
      hydrateWithCSV(text);
    }

    function hydrateWithCSV(text){
      const rows=parseCSV(text);
      if(!rows.length){ showToast('CSV vacío o con encabezados inválidos'); return; }
      state.jobs = normalizeRows(rows);
      populateCities();
      buildSidebar(state.jobs);
      state.filtered=[...state.jobs];
      stateUI.page=1;
      renderList(state.filtered);
      updateCharts(state.filtered);
      $('#empty').style.display='none';
      showToast('Vacantes cargadas', true);
      handleHashRoute();
    }

    // Selección manual (file:// o fallo de fetch)
    async function openFilePicker(){
      try{
        if(window.showOpenFilePicker){
          const [handle] = await window.showOpenFilePicker({types:[{description:'CSV',accept:{'text/csv':['.csv'],'text/plain':['.csv']}}]});
          const file = await handle.getFile();
          const text = await file.text();
          hydrateWithCSV(text);
        }else{
          $('#fileInput').click();
        }
      }catch(e){
        console.warn(e);
        showToast('No se seleccionó archivo');
      }
    }
    $('#pickCsv').addEventListener('click', openFilePicker);
    $('#fileInput').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const text=await f.text();
      hydrateWithCSV(text);
    });

    // ------- Inicialización -------
    function setHeader(){ setHeaderDate(); buildPromo(); }
    setHeader();
    closeAsideMobile();
    loadCSV();

    // Redibuja charts al redimensionar
    window.addEventListener('resize', ()=> updateCharts(state.filtered || []) );
  })();
  </script>
</body>
</html>
